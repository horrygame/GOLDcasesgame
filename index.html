<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∏—Ç–≤–∞ –ö—Ä–µ–ø–æ—Å—Ç–µ–π: –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background: linear-gradient(135deg, #3e2723, #5d4037);
            color: #f5e8c8;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #device-selector {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(61, 43, 31, 0.95);
            z-index: 100;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect fill="%235d4037" width="100" height="100"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%233e2723" stroke-width="2"/></svg>');
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            overflow: hidden;
            border: 8px solid #5d4037;
            display: flex;
            flex-direction: column;
        }
        
        #game-canvas {
            width: 100%;
            flex-grow: 1;
            cursor: pointer;
            background: #7cb342;
        }
        
        #code-panel {
            width: 100%;
            height: 40%;
            background: rgba(61, 43, 31, 0.95);
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(61, 43, 31, 0.95);
            z-index: 10;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect fill="%235d4037" width="100" height="100"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%233e2723" stroke-width="2"/></svg>');
            padding: 20px;
            overflow-y: auto;
        }
        
        .hidden {
            display: none;
        }
        
        h1 {
            font-size: 36px;
            color: #d7ccc8;
            margin-bottom: 20px;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.7);
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 3px solid #8d6e63;
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 28px;
            color: #d7ccc8;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            text-align: center;
            font-weight: bold;
        }
        
        h3 {
            font-size: 20px;
            color: #d7ccc8;
            margin-bottom: 15px;
            text-align: center;
        }
        
        p {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            max-width: 100%;
            line-height: 1.5;
            color: #efebe9;
        }
        
        .button {
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            min-width: 160px;
            text-align: center;
            border: 2px solid #5d4037;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .button:hover {
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        
        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .menu-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }
        
        .code-editor {
            background: #2d2d2d;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 15px;
            flex-grow: 1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #f8f8f2;
            line-height: 1.5;
            overflow: auto;
            border: 2px solid #8d6e63;
            min-height: 150px;
        }
        
        .code-example {
            background: #1e1e1e;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #f8f8f2;
            line-height: 1.5;
            border-left: 4px solid #8d6e63;
        }
        
        .code-keyword {
            color: #ff79c6;
            font-weight: bold;
        }
        
        .code-function {
            color: #50fa7b;
        }
        
        .code-comment {
            color: #6272a4;
            font-style: italic;
        }
        
        .code-string {
            color: #f1fa8c;
        }
        
        .code-number {
            color: #bd93f9;
        }
        
        .instructions {
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #8d6e63;
            max-width: 100%;
        }
        
        .instructions h3 {
            color: #ffd54f;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .instructions li {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        
        .ui-panel {
            background: rgba(93, 64, 55, 0.8);
            padding: 8px 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: #f5e8c8;
        }
        
        .preparation-panel {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(93, 64, 55, 0.8);
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 18px;
            z-index: 5;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: #f5e8c8;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .game-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(61, 43, 31, 0.95);
            padding: 30px;
            border-radius: 5px;
            text-align: center;
            z-index: 20;
            border: 3px solid #8d6e63;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
        }
        
        .damage-popup {
            position: absolute;
            color: #ff5252;
            font-weight: bold;
            font-size: 16px;
            pointer-events: none;
            z-index: 15;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 1s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
        
        .energy-warning {
            color: #ff5252;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .medieval-border {
            border: 8px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z M10,10 L90,10 L90,90 L10,90 Z" fill="none" stroke="%238d6e63" stroke-width="4"/></svg>') 8 round;
        }
        
        .parchment {
            background: #f5e8c8;
            color: #5d4037;
            padding: 12px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #8d6e63;
        }
        
        .code-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .compile-message {
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
            border: 1px solid #4caf50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
            border: 1px solid #f44336;
        }
        
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 100%;
            margin-top: 20px;
        }
        
        .level-card {
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            border: 2px solid #8d6e63;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            background: rgba(121, 85, 72, 0.8);
        }
        
        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .level-title {
            font-size: 16px;
            margin-bottom: 8px;
            color: #ffd54f;
        }
        
        .level-description {
            font-size: 12px;
            color: #efebe9;
        }
        
        .manual-container {
            max-width: 100%;
            max-height: 70vh;
            overflow-y: auto;
            padding: 15px;
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            border: 2px solid #8d6e63;
        }
        
        .manual-section {
            margin-bottom: 20px;
        }
        
        .manual-section h3 {
            color: #ffd54f;
            border-bottom: 1px solid #8d6e63;
            padding-bottom: 5px;
            margin-bottom: 12px;
        }
        
        .manual-function {
            background: rgba(121, 85, 72, 0.5);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .function-name {
            color: #50fa7b;
            font-weight: bold;
        }
        
        .function-description {
            margin-left: 8px;
            color: #efebe9;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .device-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            width: 100%;
        }
        
        .device-button {
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            color: #fff;
            border: none;
            padding: 20px;
            font-size: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 2px solid #5d4037;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .device-button:hover {
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        
        @media (min-width: 768px) {
            #game-container {
                width: 95%;
                height: 95%;
                max-width: 1400px;
                max-height: 800px;
                flex-direction: row;
            }
            
            #game-canvas {
                width: 60%;
                height: 100%;
            }
            
            #code-panel {
                width: 40%;
                height: 100%;
            }
            
            h1 {
                font-size: 48px;
            }
            
            h2 {
                font-size: 36px;
            }
            
            .button {
                padding: 15px 30px;
                font-size: 18px;
                min-width: 200px;
            }
            
            .code-editor {
                font-size: 16px;
            }
            
            .levels-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .device-buttons {
                flex-direction: row;
                max-width: 600px;
            }
        }
        
        @media (min-width: 1024px) {
            h1 {
                font-size: 64px;
            }
        }
    </style>
</head>
<body>
    <div id="device-selector">
        <h1>‚öîÔ∏è –ë–∏—Ç–≤–∞ –ö—Ä–µ–ø–æ—Å—Ç–µ–π ‚öîÔ∏è</h1>
        <p class="parchment">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        
        <div class="device-buttons">
            <button class="device-button" id="mobile-btn">
                üì± –¢–µ–ª–µ—Ñ–æ–Ω
            </button>
            <button class="device-button" id="desktop-btn">
                üíª –ö–æ–º–ø—å—é—Ç–µ—Ä
            </button>
        </div>
    </div>
    
    <div id="game-container" class="medieval-border hidden">
        <canvas id="game-canvas"></canvas>
        
        <div id="code-panel">
            <h3 id="level-title">–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            
            <div class="instructions">
                <div id="level-description">
                    <p>–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–∏—Ç –≤–∞—à–∏—Ö –≤–æ–∏–Ω–æ–≤ –∑–∞—â–∏—â–∞—Ç—å –∑–∞–º–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–≤–∏–∂–µ–Ω–∏—è –∏ –∞—Ç–∞–∫–∏.</p>
                </div>
            </div>
            
            <div id="compile-message" class="compile-message hidden"></div>
            
            <div class="code-controls">
                <button class="button" id="compile-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥</button>
                <button class="button" id="reset-code-btn">–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–¥</button>
            </div>
            
            <textarea id="code-editor" class="code-editor" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–¥ –∑–¥–µ—Å—å...">
–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()
            </textarea>
            
            <div class="nav-buttons">
                <button class="button" id="back-to-menu-btn">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                <button class="button" id="next-level-btn" style="display:none">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
            </div>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="main-menu" class="screen">
            <h1>‚öîÔ∏è –ë–∏—Ç–≤–∞ –ö—Ä–µ–ø–æ—Å—Ç–µ–π ‚öîÔ∏è</h1>
            <p class="parchment">–û–±—É—á–∞—é—â–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞</p>
            
            <div class="menu-buttons">
                <button class="button" id="levels-btn">üó∫Ô∏è –£—Ä–æ–≤–Ω–∏</button>
                <button class="button" id="manual-btn">üìö –ü–æ—Å–æ–±–∏–µ</button>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω —É—Ä–æ–≤–Ω–µ–π -->
        <div id="levels-screen" class="screen hidden">
            <h2>üó∫Ô∏è –£—Ä–æ–≤–Ω–∏ –æ–±—É—á–µ–Ω–∏—è</h2>
            <p class="parchment">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            
            <div class="levels-grid">
                <div class="level-card" data-level="1">
                    <div class="level-title">–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã</div>
                    <div class="level-description">–ò–∑—É—á–∏—Ç–µ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                </div>
                <div class="level-card locked" data-level="2">
                    <div class="level-title">–£—Ä–æ–≤–µ–Ω—å 2: –í–µ—Ç–≤–ª–µ–Ω–∏—è</div>
                    <div class="level-description">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Å–ª–æ–≤–∏—è –µ—Å–ª–∏/–∏–Ω–∞—á–µ</div>
                </div>
                <div class="level-card locked" data-level="3">
                    <div class="level-title">–£—Ä–æ–≤–µ–Ω—å 3: –¶–∏–∫–ª—ã</div>
                    <div class="level-description">–ò–∑—É—á–∏—Ç–µ —Ü–∏–∫–ª—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å</div>
                </div>
                <div class="level-card locked" data-level="4">
                    <div class="level-title">–£—Ä–æ–≤–µ–Ω—å 4: –£—Å–ª–æ–≤–∏—è –≤ —Ü–∏–∫–ª–∞—Ö</div>
                    <div class="level-description">–¶–∏–∫–ª—ã —Å —É—Å–ª–æ–≤–∏–µ–º –ø–æ–∫–∞</div>
                </div>
                <div class="level-card locked" data-level="5">
                    <div class="level-title">–£—Ä–æ–≤–µ–Ω—å 5: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    <div class="level-description">–°–ª–æ–∂–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∑–∞—â–∏—Ç—ã</div>
                </div>
                <div class="level-card locked" data-level="6">
                    <div class="level-title">–£—Ä–æ–≤–µ–Ω—å 6: –§–∏–Ω–∞–ª—å–Ω—ã–π</div>
                    <div class="level-description">–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –≤—Å–µ –∑–Ω–∞–Ω–∏—è</div>
                </div>
            </div>
            
            <button class="button" id="levels-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –ø–æ—Å–æ–±–∏—è -->
        <div id="manual-screen" class="screen hidden">
            <h2>üìö –ü–æ—Å–æ–±–∏–µ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é</h2>
            
            <div class="manual-container">
                <div class="manual-section">
                    <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3>
                    <div class="manual-function">
                        <span class="function-name">–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()</span>
                        <span class="function-description">- –∞—Ç–∞–∫–æ–≤–∞—Ç—å –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–¥–≤–∏–≥–∞—Ç—å—Å—è_–∫(x, y)</span>
                        <span class="function-description">- –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥(n)</span>
                        <span class="function-description">- –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä–µ–¥ –Ω–∞ n –ø–∏–∫—Å–µ–ª–µ–π</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–¥–≤–∏–≥–∞—Ç—å—Å—è_–Ω–∞–∑–∞–¥(n)</span>
                        <span class="function-description">- –¥–≤–∏–≥–∞—Ç—å—Å—è –Ω–∞–∑–∞–¥ –Ω–∞ n –ø–∏–∫—Å–µ–ª–µ–π</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ª–µ–≤–æ(n)</span>
                        <span class="function-description">- –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ª–µ–≤–æ –Ω–∞ n –ø–∏–∫—Å–µ–ª–µ–π</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø—Ä–∞–≤–æ(n)</span>
                        <span class="function-description">- –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø—Ä–∞–≤–æ –Ω–∞ n –ø–∏–∫—Å–µ–ª–µ–π</span>
                    </div>
                </div>
                
                <div class="manual-section">
                    <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π</h3>
                    <div class="manual-function">
                        <span class="function-name">–µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ()</span>
                        <span class="function-description">- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ò–°–¢–ò–ù–ê, –µ—Å–ª–∏ –≤—Ä–∞–≥ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–¥–æ_–≤—Ä–∞–≥–∞()</span>
                        <span class="function-description">- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–∑–¥–æ—Ä–æ–≤—å–µ()</span>
                        <span class="function-description">- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–¥–æ—Ä–æ–≤—å–µ —é–Ω–∏—Ç–∞</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞_x()</span>
                        <span class="function-description">- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —é–Ω–∏—Ç–∞</span>
                    </div>
                    <div class="manual-function">
                        <span class="function-name">–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞_y()</span>
                        <span class="function-description">- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —é–Ω–∏—Ç–∞</span>
                    </div>
                </div>
                
                <div class="manual-section">
                    <h3>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —è–∑—ã–∫–∞</h3>
                    <div class="code-example">
                        <span class="code-comment"># –í–µ—Ç–≤–ª–µ–Ω–∏–µ (—É—Å–ª–æ–≤–∏–µ)</span><br>
                        <span class="code-keyword">–µ—Å–ª–∏</span> —É—Å–ª–æ–≤–∏–µ:<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;–¥–µ–π—Å—Ç–≤–∏–µ<br>
                        <span class="code-keyword">–∏–Ω–∞—á–µ</span>:<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;–¥—Ä—É–≥–æ–µ_–¥–µ–π—Å—Ç–≤–∏–µ
                    </div>
                    
                    <div class="code-example">
                        <span class="code-comment"># –¶–∏–∫–ª —Å —Å—á–µ—Ç—á–∏–∫–æ–º</span><br>
                        <span class="code-keyword">–ø–æ–≤—Ç–æ—Ä–∏—Ç—å</span> 5 <span class="code-keyword">—Ä–∞–∑</span>:<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;–¥–µ–π—Å—Ç–≤–∏–µ
                    </div>
                    
                    <div class="code-example">
                        <span class="code-comment"># –¶–∏–∫–ª —Å —É—Å–ª–æ–≤–∏–µ–º</span><br>
                        <span class="code-keyword">–ø–æ–∫–∞</span> —É—Å–ª–æ–≤–∏–µ <span class="code-keyword">–∏—Å—Ç–∏–Ω–Ω–æ</span>:<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;–¥–µ–π—Å—Ç–≤–∏–µ
                    </div>
                </div>
            </div>
            
            <button class="button" id="manual-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- –ò–≥—Ä–æ–≤–æ–π UI (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞) -->
        <div id="game-ui" class="game-ui hidden">
            <div class="ui-panel" id="energy-panel">
                ‚ö° <span id="game-energy">100</span>/<span id="game-max-energy">100</span>
            </div>
            <div class="ui-panel">
                ‚ù§Ô∏è <span id="game-health">1000</span>
            </div>
            <div class="ui-panel">
                ‚è±Ô∏è <span id="game-timer">60</span>—Å
            </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ -->
        <div id="preparation-panel" class="preparation-panel hidden">
            <div>–§–∞–∑–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</div>
            <div id="preparation-timer">60</div>
            <button class="button" id="start-early-btn">–ù–∞—á–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ</button>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã -->
        <div id="game-result" class="game-result hidden">
            <h2 id="result-title">–ü–û–ë–ï–î–ê!</h2>
            <p id="result-message">–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—â–∏—Ç–∏–ª–∏ –∫—Ä–µ–ø–æ—Å—Ç—å!</p>
            <button class="button" id="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã
        let SCREEN_WIDTH = window.innerWidth;
        let SCREEN_HEIGHT = window.innerHeight * 0.6; // 60% –≤—ã—Å–æ—Ç—ã –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        const FPS = 60;
        const PREPARATION_TIME = 60;
        const BATTLE_DURATION = 120;

        // –£—Ä–æ–≤–Ω–∏ –æ–±—É—á–µ–Ω–∏—è
        const levels = {
            1: {
                title: "–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–∏—Ç –≤–∞—à–∏—Ö –≤–æ–∏–Ω–æ–≤ –∑–∞—â–∏—â–∞—Ç—å –∑–∞–º–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–≤–∏–∂–µ–Ω–∏—è –∏ –∞—Ç–∞–∫–∏.",
                startCode: "–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()",
                goal: "–ó–∞—â–∏—Ç–∏—Ç–µ –∑–∞–º–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥",
                duration: 30,
                allowedFunctions: ["–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–∫", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–Ω–∞–∑–∞–¥", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ª–µ–≤–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø—Ä–∞–≤–æ"]
            },
            2: {
                title: "–£—Ä–æ–≤–µ–Ω—å 2: –í–µ—Ç–≤–ª–µ–Ω–∏—è",
                description: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –µ—Å–ª–∏/–∏–Ω–∞—á–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–º–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è —é–Ω–∏—Ç–æ–≤.",
                startCode: `–µ—Å–ª–∏ –µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ():
    –∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()
–∏–Ω–∞—á–µ:
    –¥–≤–∏–≥–∞—Ç—å—Å—è_–∫(400, 400)`,
                goal: "–ó–∞—â–∏—Ç–∏—Ç–µ –∑–∞–º–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É—Å–ª–æ–≤–∏–π",
                duration: 45,
                allowedFunctions: ["–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–∫", "–µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ"]
            },
            3: {
                title: "–£—Ä–æ–≤–µ–Ω—å 3: –¶–∏–∫–ª—ã",
                description: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–∏–∫–ª—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –¥–µ–π—Å—Ç–≤–∏–π.",
                startCode: `–ø–æ–≤—Ç–æ—Ä–∏—Ç—å 5 —Ä–∞–∑:
    –¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥(50)
    –∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()`,
                goal: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–∏–∫–ª—ã –¥–ª—è –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏",
                duration: 60,
                allowedFunctions: ["–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–Ω–∞–∑–∞–¥", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ª–µ–≤–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø—Ä–∞–≤–æ"]
            },
            4: {
                title: "–£—Ä–æ–≤–µ–Ω—å 4: –£—Å–ª–æ–≤–∏—è –≤ —Ü–∏–∫–ª–∞—Ö",
                description: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–∏–∫–ª—ã —Å —É—Å–ª–æ–≤–∏–µ–º –ø–æ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.",
                startCode: `–ø–æ–∫–∞ –µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ() –∏—Å—Ç–∏–Ω–Ω–æ:
    –∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()`,
                goal: "–°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∑–∞—â–∏—Ç—É —Å –ø–æ–º–æ—â—å—é —Ü–∏–∫–ª–æ–≤",
                duration: 60,
                allowedFunctions: ["–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ", "–µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ"]
            },
            5: {
                title: "–£—Ä–æ–≤–µ–Ω—å 5: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
                description: "–°–∫–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ –≤—Å–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∑–∞—â–∏—Ç—ã.",
                startCode: `–µ—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–¥–æ_–≤—Ä–∞–≥–∞() < 100:
    –∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ()
–∏–Ω–∞—á–µ:
    –ø–æ–≤—Ç–æ—Ä–∏—Ç—å 3 —Ä–∞–∑:
        –¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥(30)`,
                goal: "–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –∑–∞—â–∏—Ç—ã",
                duration: 90,
                allowedFunctions: ["–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥", "—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–¥–æ_–≤—Ä–∞–≥–∞"]
            },
            6: {
                title: "–£—Ä–æ–≤–µ–Ω—å 6: –§–∏–Ω–∞–ª—å–Ω—ã–π",
                description: "–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–¥–µ–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã –∑–∞–º–∫–∞.",
                startCode: `# –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∑–∞—â–∏—Ç—ã
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏`,
                goal: "–ó–∞—â–∏—Ç–∏—Ç–µ –∑–∞–º–æ–∫ –æ—Ç –º–æ—â–Ω–æ–π –∞—Ç–∞–∫–∏",
                duration: 120,
                allowedFunctions: ["–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–∫", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–Ω–∞–∑–∞–¥", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ª–µ–≤–æ", "–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø—Ä–∞–≤–æ", "–µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ", "—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–¥–æ_–≤—Ä–∞–≥–∞", "–∑–¥–æ—Ä–æ–≤—å–µ", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞_x", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞_y"]
            }
        };

        // –¶–≤–µ—Ç–∞ –≤ —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–æ–º —Å—Ç–∏–ª–µ
        const COLORS = {
            BACKGROUND: '#5d4037',
            GOLD: '#ffd54f',
            ENERGY: '#4fc3f7',
            HEALTH: '#ef5350',
            TEXT: '#f5e8c8',
            BUTTON: '#8d6e63',
            BUTTON_HOVER: '#a1887f',
            PANEL: 'rgba(93, 64, 55, 0.8)',
            CASTLE: '#6d4c41',
            BATTLEFIELD: '#7cb342',
            RARITY: {
                common: '#a1887f',
                rare: '#4fc3f7',
                epic: '#ba68c8',
                mythic: '#ffb74d',
                legendary: '#ffd54f'
            }
        };

        // –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const characters = {
            'white_guy': {
                'name': '–ë–µ–ª—ã–π –í–æ–∏–Ω',
                'image': 'white_guy.png',
                'cost': 10,
                'health': 100,
                'damage': 20,
                'speed': 1.5,
                'attack_speed': 1.0,
                'attack_range': 80,
                'vision_range': 150,
                'description': '–ë–∞–∑–æ–≤—ã–π –±–æ–µ—Ü, —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏',
                'rarity': 'common',
                'ability': null,
                'owned': true
            }
        };

        const enemyTypes = [
            {health: 80, damage: 15, speed: 1.0, attack_speed: 1.0, attack_range: 70, vision_range: 120, image: 'white_guy.png'},
            {health: 50, damage: 25, speed: 1.5, attack_speed: 1.2, attack_range: 90, vision_range: 130, image: 'yellow_guy.png'},
            {health: 120, damage: 10, speed: 0.8, attack_speed: 0.8, attack_range: 60, vision_range: 110, image: 'red_guy.png'}
        ];

        // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let gameState = {
            currentScreen: 'main_menu',
            gamePhase: 'preparation',
            energy: 100,
            maxEnergy: 100,
            playerHealth: 1000,
            maxCastleHealth: 1000,
            ownedCharacters: Object.keys(characters),
            units: [],
            enemyUnits: [],
            enemySpawnTimer: 0,
            unitCounter: 0,
            enemyCounter: 0,
            lastSecondUpdate: 0,
            preparationTimeLeft: PREPARATION_TIME,
            battleTimeLeft: BATTLE_DURATION,
            gameOver: false,
            gameResult: null,
            damagePopups: [],
            selectedCharacter: null,
            selectedUnit: null,
            gamesPlayed: 0,
            gamesWon: 0,
            playerCode: '',
            compiledCode: null,
            currentLevel: 1,
            completedLevels: [1],
            unitDirections: {}, // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —é–Ω–∏—Ç–∞
            isMobile: false
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const deviceSelector = document.getElementById('device-selector');
        const gameContainer = document.getElementById('game-container');

        const screens = {
            main_menu: document.getElementById('main-menu'),
            levels: document.getElementById('levels-screen'),
            manual: document.getElementById('manual-screen'),
            game: null
        };

        // –ö–Ω–æ–ø–∫–∏
        const buttons = {
            mobile: document.getElementById('mobile-btn'),
            desktop: document.getElementById('desktop-btn'),
            levels: document.getElementById('levels-btn'),
            manual: document.getElementById('manual-btn'),
            levelsBack: document.getElementById('levels-back-btn'),
            manualBack: document.getElementById('manual-back-btn'),
            continue: document.getElementById('continue-btn'),
            startEarly: document.getElementById('start-early-btn'),
            compile: document.getElementById('compile-btn'),
            resetCode: document.getElementById('reset-code-btn'),
            backToMenu: document.getElementById('back-to-menu-btn'),
            nextLevel: document.getElementById('next-level-btn')
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ–¥–∞
        const codeEditor = document.getElementById('code-editor');
        const compileMessage = document.getElementById('compile-message');
        const levelTitle = document.getElementById('level-title');
        const levelDescription = document.getElementById('level-description');

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const stats = {
            gameEnergy: document.getElementById('game-energy'),
            gameMaxEnergy: document.getElementById('game-max-energy'),
            gameHealth: document.getElementById('game-health'),
            gameTimer: document.getElementById('game-timer')
        };

        // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const gameResult = document.getElementById('game-result');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');

        // –ò–≥—Ä–æ–≤–æ–π UI
        const gameUI = document.getElementById('game-ui');
        const preparationPanel = document.getElementById('preparation-panel');
        const preparationTimer = document.getElementById('preparation-timer');
        const energyPanel = document.getElementById('energy-panel');

        // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const images = {};

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function distance(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
        function updateCanvasSize() {
            if (gameState.isMobile) {
                SCREEN_WIDTH = window.innerWidth;
                SCREEN_HEIGHT = window.innerHeight * 0.6;
            } else {
                SCREEN_WIDTH = 800;
                SCREEN_HEIGHT = 800;
            }
            
            canvas.width = SCREEN_WIDTH;
            canvas.height = SCREEN_HEIGHT;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function init() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
            setupButtons();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
            updateCanvasSize();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            loadImages().then(() => {
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω–µ–π
                setupLevels();
                
                // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
                gameLoop();
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', updateCanvasSize);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function loadImages() {
            const promises = [];
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            Object.values(characters).forEach(character => {
                promises.push(loadImage(character.image));
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Ä–∞–≥–æ–≤
            enemyTypes.forEach(enemy => {
                promises.push(loadImage(enemy.image));
            });
            
            return Promise.all(promises);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    images[src] = img;
                    resolve();
                };
                img.onerror = () => {
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    const canvas = document.createElement('canvas');
                    canvas.width = 60;
                    canvas.height = 60;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(0, 0, 60, 60);
                    ctx.fillStyle = '#5d4037';
                    ctx.font = '10px Arial';
                    ctx.fillText('IMG', 20, 30);
                    images[src] = canvas;
                    resolve();
                };
                img.src = src;
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫
        function setupButtons() {
            // –í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            buttons.mobile.addEventListener('click', () => {
                gameState.isMobile = true;
                deviceSelector.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                updateCanvasSize();
            });
            
            buttons.desktop.addEventListener('click', () => {
                gameState.isMobile = false;
                deviceSelector.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                updateCanvasSize();
            });
            
            // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            buttons.levels.addEventListener('click', () => showScreen('levels'));
            buttons.manual.addEventListener('click', () => showScreen('manual'));
            
            // –ö–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            buttons.levelsBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.manualBack.addEventListener('click', () => showScreen('main_menu'));
            
            // –ò–≥—Ä–∞
            buttons.continue.addEventListener('click', () => {
                gameResult.classList.add('hidden');
                showScreen('main_menu');
            });
            
            // –ù–∞—á–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ
            buttons.startEarly.addEventListener('click', startBattle);
            
            // –ö–æ–¥
            buttons.compile.addEventListener('click', compileCode);
            buttons.resetCode.addEventListener('click', resetCode);
            buttons.backToMenu.addEventListener('click', () => showScreen('main_menu'));
            buttons.nextLevel.addEventListener('click', nextLevel);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω–µ–π
        function setupLevels() {
            const levelCards = document.querySelectorAll('.level-card');
            levelCards.forEach(card => {
                card.addEventListener('click', function() {
                    const level = parseInt(this.getAttribute('data-level'));
                    if (!this.classList.contains('locked')) {
                        startLevel(level);
                    }
                });
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
            updateLevels();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
        function updateLevels() {
            const levelCards = document.querySelectorAll('.level-card');
            levelCards.forEach(card => {
                const level = parseInt(card.getAttribute('data-level'));
                if (gameState.completedLevels.includes(level) || level === 1) {
                    card.classList.remove('locked');
                }
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            Object.values(screens).forEach(screen => {
                if (screen) screen.classList.add('hidden');
            });
            
            // –°–∫—Ä—ã—Ç—å –∏–≥—Ä–æ–≤–æ–π UI
            gameUI.classList.add('hidden');
            preparationPanel.classList.add('hidden');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
            if (screenName === 'game') {
                // –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω —Ä–∏—Å—É–µ—Ç—Å—è –Ω–∞ canvas
                gameUI.classList.remove('hidden');
                
                if (gameState.gamePhase === 'preparation') {
                    preparationPanel.classList.remove('hidden');
                }
            } else if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
            
            gameState.currentScreen = screenName;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            // –ò–≥—Ä–∞
            stats.gameEnergy.textContent = gameState.energy;
            stats.gameMaxEnergy.textContent = gameState.maxEnergy;
            stats.gameHealth.textContent = gameState.playerHealth;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã –∏–≥—Ä—ã
            if (gameState.gamePhase === 'preparation') {
                stats.gameTimer.textContent = Math.ceil(gameState.preparationTimeLeft);
                preparationTimer.textContent = Math.ceil(gameState.preparationTimeLeft);
            } else if (gameState.gamePhase === 'battle') {
                stats.gameTimer.textContent = Math.ceil(gameState.battleTimeLeft);
            }
        }

        // –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∫–æ–¥–∞
        function compileCode() {
            const code = codeEditor.value;
            gameState.playerCode = code;
            
            try {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä—É—Å—Å–∫–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ JavaScript
                let jsCode = code
                    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    .replace(/#.*$/gm, '')
                    // –í–µ—Ç–≤–ª–µ–Ω–∏—è
                    .replace(/–µ—Å–ª–∏\s+(.+)\s*:/g, 'if($1) {')
                    .replace(/–∏–Ω–∞—á–µ\s*:/g, '} else {')
                    // –¶–∏–∫–ª—ã
                    .replace(/–ø–æ–≤—Ç–æ—Ä–∏—Ç—å\s+(\d+)\s+—Ä–∞–∑\s*:/g, 'for(let i = 0; i < $1; i++) {')
                    .replace(/–ø–æ–∫–∞\s+(.+)\s+–∏—Å—Ç–∏–Ω–Ω–æ\s*:/g, 'while($1) {')
                    // –§—É–Ω–∫—Ü–∏–∏
                    .replace(/–∞—Ç–∞–∫–æ–≤–∞—Ç—å_–±–ª–∏–∂–∞–π—à–µ–≥–æ\s*\(\s*\)/g, 'attackNearestEnemy()')
                    .replace(/–¥–≤–∏–≥–∞—Ç—å—Å—è_–∫\s*\(\s*([^,]+)\s*,\s*([^)]+)\s*\)/g, 'moveTo($1, $2)')
                    .replace(/–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø–µ—Ä–µ–¥\s*\(\s*([^)]+)\s*\)/g, 'moveForward($1)')
                    .replace(/–¥–≤–∏–≥–∞—Ç—å—Å—è_–Ω–∞–∑–∞–¥\s*\(\s*([^)]+)\s*\)/g, 'moveBackward($1)')
                    .replace(/–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ª–µ–≤–æ\s*\(\s*([^)]+)\s*\)/g, 'moveLeft($1)')
                    .replace(/–¥–≤–∏–≥–∞—Ç—å—Å—è_–≤–ø—Ä–∞–≤–æ\s*\(\s*([^)]+)\s*\)/g, 'moveRight($1)')
                    .replace(/–µ—Å—Ç—å_–≤—Ä–∞–≥_–≤_—Ä–∞–¥–∏—É—Å–µ\s*\(\s*\)/g, 'enemyInRange()')
                    .replace(/—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–¥–æ_–≤—Ä–∞–≥–∞\s*\(\s*\)/g, 'distanceToEnemy()')
                    .replace(/–∑–¥–æ—Ä–æ–≤—å–µ\s*\(\s*\)/g, 'getHealth()')
                    .replace(/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞_x\s*\(\s*\)/g, 'getX()')
                    .replace(/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞_y\s*\(\s*\)/g, 'getY()');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –±–ª–æ–∫–∏
                const openBlocks = (jsCode.match(/{/g) || []).length - (jsCode.match(/}/g) || []).length;
                for (let i = 0; i < openBlocks; i++) {
                    jsCode += '}';
                }
                
                // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –∫–æ–¥–∞
                gameState.compiledCode = new Function('unit', 'api', jsCode);
                
                showCompileMessage('–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω!', 'success');
            } catch (error) {
                showCompileMessage('–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: ' + error.message, 'error');
                console.error('–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏:', error);
            }
        }

        // –°–±—Ä–æ—Å –∫–æ–¥–∞
        function resetCode() {
            codeEditor.value = levels[gameState.currentLevel].startCode;
            compileMessage.classList.add('hidden');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
        function showCompileMessage(message, type) {
            compileMessage.textContent = message;
            compileMessage.className = 'compile-message ' + type;
            compileMessage.classList.remove('hidden');
            
            setTimeout(() => {
                compileMessage.classList.add('hidden');
            }, 3000);
        }

        // API –¥–ª—è —é–Ω–∏—Ç–æ–≤
        function createUnitAPI(unit) {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —é–Ω–∏—Ç–∞, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
            if (!gameState.unitDirections[unit.id]) {
                gameState.unitDirections[unit.id] = 0; // 0 –≥—Ä–∞–¥—É—Å–æ–≤ (–≤–ø—Ä–∞–≤–æ)
            }
            
            return {
                attackNearestEnemy: function() {
                    let closestEnemy = null;
                    let closestDistance = unit.visionRange;
                    
                    gameState.enemyUnits.forEach(enemy => {
                        const dist = distance(unit.x, unit.y, enemy.x, enemy.y);
                        if (dist < closestDistance) {
                            closestDistance = dist;
                            closestEnemy = enemy;
                        }
                    });
                    
                    if (closestEnemy) {
                        unit.target = closestEnemy;
                        unit.state = 'chasing';
                    }
                },
                
                moveTo: function(x, y) {
                    unit.moveTarget = {x: parseInt(x), y: parseInt(y)};
                    unit.target = null;
                    unit.state = 'moving';
                },
                
                moveForward: function(distance) {
                    const dir = gameState.unitDirections[unit.id];
                    const dx = Math.cos(dir * Math.PI / 180) * parseInt(distance);
                    const dy = Math.sin(dir * Math.PI / 180) * parseInt(distance);
                    
                    unit.moveTarget = {x: unit.x + dx, y: unit.y + dy};
                    unit.target = null;
                    unit.state = 'moving';
                },
                
                moveBackward: function(distance) {
                    const dir = gameState.unitDirections[unit.id];
                    const dx = -Math.cos(dir * Math.PI / 180) * parseInt(distance);
                    const dy = -Math.sin(dir * Math.PI / 180) * parseInt(distance);
                    
                    unit.moveTarget = {x: unit.x + dx, y: unit.y + dy};
                    unit.target = null;
                    unit.state = 'moving';
                },
                
                moveLeft: function(distance) {
                    const dir = gameState.unitDirections[unit.id] - 90;
                    const dx = Math.cos(dir * Math.PI / 180) * parseInt(distance);
                    const dy = Math.sin(dir * Math.PI / 180) * parseInt(distance);
                    
                    unit.moveTarget = {x: unit.x + dx, y: unit.y + dy};
                    unit.target = null;
                    unit.state = 'moving';
                },
                
                moveRight: function(distance) {
                    const dir = gameState.unitDirections[unit.id] + 90;
                    const dx = Math.cos(dir * Math.PI / 180) * parseInt(distance);
                    const dy = Math.sin(dir * Math.PI / 180) * parseInt(distance);
                    
                    unit.moveTarget = {x: unit.x + dx, y: unit.y + dy};
                    unit.target = null;
                    unit.state = 'moving';
                },
                
                enemyInRange: function() {
                    for (let i = 0; i < gameState.enemyUnits.length; i++) {
                        const enemy = gameState.enemyUnits[i];
                        const dist = distance(unit.x, unit.y, enemy.x, enemy.y);
                        if (dist < unit.attackRange) {
                            return true;
                        }
                    }
                    return false;
                },
                
                distanceToEnemy: function() {
                    let minDistance = Infinity;
                    
                    gameState.enemyUnits.forEach(enemy => {
                        const dist = distance(unit.x, unit.y, enemy.x, enemy.y);
                        if (dist < minDistance) {
                            minDistance = dist;
                        }
                    });
                    
                    return minDistance;
                },
                
                getHealth: function() {
                    return unit.health;
                },
                
                getX: function() {
                    return unit.x;
                },
                
                getY: function() {
                    return unit.y;
                }
            };
        }

        // –ù–∞—á–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å
        function startLevel(level) {
            gameState.currentLevel = level;
            const levelData = levels[level];
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —É—Ä–æ–≤–Ω—è
            levelTitle.textContent = levelData.title;
            levelDescription.innerHTML = `<p>${levelData.description}</p><p><strong>–¶–µ–ª—å:</strong> ${levelData.goal}</p>`;
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
            codeEditor.value = levelData.startCode;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
            gameState.playerHealth = gameState.maxCastleHealth;
            gameState.energy = gameState.maxEnergy;
            gameState.units = [];
            gameState.enemyUnits = [];
            gameState.enemySpawnTimer = 0;
            gameState.unitCounter = 0;
            gameState.enemyCounter = 0;
            gameState.preparationTimeLeft = PREPARATION_TIME;
            gameState.battleTimeLeft = levelData.duration;
            gameState.gamePhase = 'preparation';
            gameState.gameOver = false;
            gameState.gameResult = null;
            gameState.damagePopups = [];
            gameState.selectedCharacter = null;
            gameState.selectedUnit = null;
            gameState.lastSecondUpdate = Date.now();
            gameState.unitDirections = {};
            
            // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
            buttons.nextLevel.style.display = 'none';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∫–æ–¥–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —É—Ä–æ–≤–Ω—è
            compileCode();
            
            showScreen('game');
        }

        // –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        function nextLevel() {
            const nextLevel = gameState.currentLevel + 1;
            if (levels[nextLevel]) {
                // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
                if (!gameState.completedLevels.includes(nextLevel)) {
                    gameState.completedLevels.push(nextLevel);
                    updateLevels();
                }
                startLevel(nextLevel);
            } else {
                showScreen('main_menu');
            }
        }

        // –ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É (–∑–∞–≤–µ—Ä—à–∏—Ç—å —Ñ–∞–∑—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏)
        function startBattle() {
            gameState.gamePhase = 'battle';
            preparationPanel.classList.add('hidden');
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ —é–Ω–∏—Ç–∞
        function placeUnit(x, y) {
            if (gameState.energy >= characters['white_guy'].cost) {
                const character = characters['white_guy'];
                
                gameState.energy -= character.cost;
                gameState.unitCounter++;
                gameState.units.push({
                    id: `unit_${gameState.unitCounter}`,
                    characterId: 'white_guy',
                    x: x,
                    y: y,
                    health: character.health,
                    maxHealth: character.health,
                    damage: character.damage,
                    speed: character.speed,
                    attackSpeed: character.attack_speed,
                    attackRange: character.attack_range,
                    visionRange: character.vision_range,
                    image: character.image,
                    target: null,
                    moveTarget: null,
                    lastAttackTime: 0,
                    state: 'idle'
                });
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                createDamagePopup(x, y, `-${character.cost}‚ö°`, '#4fc3f7');
                updateStats();
                
                return true;
            } else {
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —ç–Ω–µ—Ä–≥–∏–∏
                energyPanel.classList.add('energy-warning');
                setTimeout(() => {
                    energyPanel.classList.remove('energy-warning');
                }, 1000);
                
                createDamagePopup(x, y, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!", '#ef5350');
                return false;
            }
        }

        // –°–ø–∞–≤–Ω –≤—Ä–∞–∂–µ—Å–∫–æ–≥–æ —é–Ω–∏—Ç–∞
        function spawnEnemyUnit() {
            const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            // –°–ø–∞–≤–Ω —Å –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞
            let x, y;
            const side = Math.floor(Math.random() * 4);
            
            switch (side) {
                case 0: // –í–µ—Ä—Ö
                    x = Math.random() * SCREEN_WIDTH;
                    y = -30;
                    break;
                case 1: // –ü—Ä–∞–≤–æ
                    x = SCREEN_WIDTH + 30;
                    y = Math.random() * SCREEN_HEIGHT;
                    break;
                case 2: // –ù–∏–∑
                    x = Math.random() * SCREEN_WIDTH;
                    y = SCREEN_HEIGHT + 30;
                    break;
                case 3: // –õ–µ–≤–æ
                    x = -30;
                    y = Math.random() * SCREEN_HEIGHT;
                    break;
            }
            
            gameState.enemyCounter++;
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–∞–≥–∞ —Å —Ü–µ–ª—å—é - –∑–∞–º–∫–æ–º
            const enemy = {
                id: `enemy_${gameState.enemyCounter}`,
                x: x,
                y: y,
                health: enemyType.health,
                maxHealth: enemyType.health,
                damage: enemyType.damage,
                speed: enemyType.speed,
                attackSpeed: enemyType.attack_speed,
                attackRange: enemyType.attack_range,
                visionRange: enemyType.vision_range,
                image: enemyType.image,
                target: {x: SCREEN_WIDTH / 2, y: SCREEN_HEIGHT / 2, isCastle: true},
                lastAttackTime: 0,
                state: 'moving'
            };
            
            gameState.enemyUnits.push(enemy);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Ä–æ–Ω–µ
        function createDamagePopup(x, y, text, color) {
            gameState.damagePopups.push({
                x: x,
                y: y,
                text: text,
                color: color,
                life: 1000,
                createdAt: Date.now()
            });
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è —é–Ω–∏—Ç–æ–≤
        function executeUnitCode() {
            if (!gameState.compiledCode) return;
            
            gameState.units.forEach(unit => {
                try {
                    const api = createUnitAPI(unit);
                    gameState.compiledCode(unit, api);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –¥–ª—è —é–Ω–∏—Ç–∞:', error);
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —é–Ω–∏—Ç–æ–≤
        function updateUnits() {
            const now = Date.now();
            const castleX = SCREEN_WIDTH / 2;
            const castleY = SCREEN_HEIGHT / 2;
            
            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–≥—Ä–æ–∫–∞ –¥–ª—è —é–Ω–∏—Ç–æ–≤
            if (gameState.gamePhase === 'battle') {
                executeUnitCode();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —é–Ω–∏—Ç–æ–≤ –∏–≥—Ä–æ–∫–∞
            gameState.units.forEach(unit => {
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                if (unit.target && unit.state === 'chasing') {
                    const dx = unit.target.x - unit.x;
                    const dy = unit.target.y - unit.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist > unit.attackRange) {
                        // –î–≤–∏–≥–∞–µ–º—Å—è –∫ —Ü–µ–ª–∏
                        unit.x += (dx / dist) * unit.speed;
                        unit.y += (dy / dist) * unit.speed;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —é–Ω–∏—Ç–∞
                        gameState.unitDirections[unit.id] = Math.atan2(dy, dx) * 180 / Math.PI;
                    } else {
                        // –ê—Ç–∞–∫—É–µ–º —Ü–µ–ª—å, –µ—Å–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏
                        unit.state = 'attacking';
                    }
                } else if (unit.moveTarget && unit.state === 'moving') {
                    // –î–≤–∏–∂–µ–Ω–∏–µ –∫ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ
                    const dx = unit.moveTarget.x - unit.x;
                    const dy = unit.moveTarget.y - unit.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist > 5) {
                        unit.x += (dx / dist) * unit.speed;
                        unit.y += (dy / dist) * unit.speed;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —é–Ω–∏—Ç–∞
                        gameState.unitDirections[unit.id] = Math.atan2(dy, dx) * 180 / Math.PI;
                    } else {
                        // –î–æ—Å—Ç–∏–≥–ª–∏ —Ç–æ—á–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                        unit.moveTarget = null;
                        unit.state = 'idle';
                    }
                }
                
                // –ê—Ç–∞–∫–∞
                if (unit.target && unit.state === 'attacking') {
                    const dist = distance(unit.x, unit.y, unit.target.x, unit.target.y);
                    
                    if (dist <= unit.attackRange) {
                        if (!unit.lastAttackTime || now - unit.lastAttackTime > (1000 / unit.attackSpeed)) {
                            unit.target.health -= unit.damage;
                            unit.lastAttackTime = now;
                            
                            // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —É—Ä–æ–Ω–∞
                            createDamagePopup(unit.target.x, unit.target.y, `-${unit.damage}`, '#ef5350');
                            
                            if (unit.target.health <= 0) {
                                gameState.enemyUnits = gameState.enemyUnits.filter(u => u !== unit.target);
                                unit.target = null;
                                unit.state = 'idle';
                            }
                        }
                    } else {
                        // –¶–µ–ª—å –≤—ã—à–ª–∞ –∏–∑ —Ä–∞–¥–∏—É—Å–∞ –∞—Ç–∞–∫–∏ - –ø—Ä–µ—Å–ª–µ–¥—É–µ–º
                        unit.state = 'chasing';
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–∂–µ—Å–∫–∏—Ö —é–Ω–∏—Ç–æ–≤
            gameState.enemyUnits.forEach(enemy => {
                // –ü–æ–∏—Å–∫ —Ü–µ–ª–∏ (—é–Ω–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞ –∏–ª–∏ –∫—Ä–µ–ø–æ—Å—Ç—å)
                if (!enemy.target) {
                    let closestTarget = null;
                    let closestDistance = enemy.visionRange;
                    
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–µ–≥–æ —é–Ω–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞
                    gameState.units.forEach(unit => {
                        const dist = distance(enemy.x, enemy.y, unit.x, unit.y);
                        if (dist < closestDistance) {
                            closestDistance = dist;
                            closestTarget = unit;
                        }
                    });
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —é–Ω–∏—Ç–∞, —Ü–µ–ª—å - –∫—Ä–µ–ø–æ—Å—Ç—å
                    if (!closestTarget) {
                        const distToCastle = distance(enemy.x, enemy.y, castleX, castleY);
                        if (distToCastle < enemy.visionRange) {
                            closestTarget = {x: castleX, y: castleY, isCastle: true};
                            closestDistance = distToCastle;
                        }
                    }
                    
                    if (closestTarget) {
                        enemy.target = closestTarget;
                    }
                }
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                if (enemy.target && enemy.state === 'moving') {
                    const dx = enemy.target.x - enemy.x;
                    const dy = enemy.target.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist > enemy.attackRange) {
                        // –î–≤–∏–≥–∞–µ–º—Å—è –∫ —Ü–µ–ª–∏
                        enemy.x += (dx / dist) * enemy.speed;
                        enemy.y += (dy / dist) * enemy.speed;
                    } else {
                        // –ê—Ç–∞–∫—É–µ–º —Ü–µ–ª—å, –µ—Å–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏
                        enemy.state = 'attacking';
                    }
                }
                
                // –ê—Ç–∞–∫–∞
                if (enemy.target && enemy.state === 'attacking') {
                    const dist = distance(enemy.x, enemy.y, enemy.target.x, enemy.target.y);
                    
                    if (dist <= enemy.attackRange) {
                        if (!enemy.lastAttackTime || now - enemy.lastAttackTime > (1000 / enemy.attackSpeed)) {
                            if (enemy.target.isCastle) {
                                // –ê—Ç–∞–∫–∞ –∫—Ä–µ–ø–æ—Å—Ç–∏
                                gameState.playerHealth -= enemy.damage;
                                createDamagePopup(castleX, castleY, `-${enemy.damage}`, '#ef5350');
                            } else {
                                // –ê—Ç–∞–∫–∞ —é–Ω–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞
                                enemy.target.health -= enemy.damage;
                                createDamagePopup(enemy.target.x, enemy.target.y, `-${enemy.damage}`, '#ef5350');
                                
                                if (enemy.target.health <= 0) {
                                    gameState.units = gameState.units.filter(u => u !== enemy.target);
                                    enemy.target = null;
                                    enemy.state = 'moving';
                                }
                            }
                            enemy.lastAttackTime = now;
                        }
                    } else {
                        // –¶–µ–ª—å –≤—ã—à–ª–∞ –∏–∑ —Ä–∞–¥–∏—É—Å–∞ –∞—Ç–∞–∫–∏ - –ø—Ä–µ—Å–ª–µ–¥—É–µ–º
                        enemy.state = 'moving';
                    }
                }
            });
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö —é–Ω–∏—Ç–æ–≤
            gameState.units = gameState.units.filter(unit => unit.health > 0);
            gameState.enemyUnits = gameState.enemyUnits.filter(unit => unit.health > 0);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Ä–æ–Ω–µ
            gameState.damagePopups = gameState.damagePopups.filter(popup => {
                return now - popup.createdAt < popup.life;
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        function updateGame() {
            const currentTime = Date.now();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            if (currentTime - gameState.lastSecondUpdate > 1000) {
                if (gameState.currentScreen === 'game') {
                    if (gameState.gamePhase === 'preparation') {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
                        gameState.preparationTimeLeft -= 1;
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∞–ª–æ –±–∏—Ç–≤—ã –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
                        if (gameState.preparationTimeLeft <= 0) {
                            startBattle();
                        }
                    } else if (gameState.gamePhase === 'battle' && !gameState.gameOver) {
                        // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è –±–∏—Ç–≤—ã
                        gameState.battleTimeLeft -= 1;
                        
                        // –°–ø–∞–≤–Ω –≤—Ä–∞–∂–µ—Å–∫–∏—Ö —é–Ω–∏—Ç–æ–≤
                        gameState.enemySpawnTimer += 1;
                        if (gameState.enemySpawnTimer >= 2) {
                            spawnEnemyUnit();
                            gameState.enemySpawnTimer = 0;
                        }
                    }
                }
                
                gameState.lastSecondUpdate = currentTime;
                updateStats();
            }
            
            // –ï—Å–ª–∏ –º—ã –≤ –∏–≥—Ä–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            if (gameState.currentScreen === 'game' && !gameState.gameOver) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∏ –∞—Ç–∞–∫ —é–Ω–∏—Ç–æ–≤
                updateUnits();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã
                if (gameState.playerHealth <= 0) {
                    gameState.gameOver = true;
                    gameState.gamesPlayed++;
                    
                    gameState.gameResult = 'lose';
                    resultTitle.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
                    resultMessage.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–π –∫–æ–¥!';
                    
                    gameResult.classList.remove('hidden');
                    updateStats();
                } else if (gameState.gamePhase === 'battle' && gameState.battleTimeLeft <= 0) {
                    gameState.gameOver = true;
                    gameState.gamesPlayed++;
                    gameState.gamesWon++;
                    
                    gameState.gameResult = 'win';
                    resultTitle.textContent = '–ü–û–ë–ï–î–ê!';
                    resultMessage.textContent = '–û—Ç–ª–∏—á–Ω—ã–π –∫–æ–¥! –í—ã –∑–∞—â–∏—Ç–∏–ª–∏ –∫—Ä–µ–ø–æ—Å—Ç—å!';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
                    if (!gameState.completedLevels.includes(gameState.currentLevel)) {
                        gameState.completedLevels.push(gameState.currentLevel);
                        updateLevels();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    if (levels[gameState.currentLevel + 1]) {
                        buttons.nextLevel.style.display = 'block';
                    }
                    
                    gameResult.classList.remove('hidden');
                    updateStats();
                }
            }
        }

        // –†–µ–Ω–¥–µ—Ä –∏–≥—Ä—ã
        function renderGame() {
            // –û—á–∏—Å—Ç–∫–∞ canvas
            ctx.fillStyle = COLORS.BACKGROUND;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // –ü–æ–ª–µ –±–æ—è - —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—ã–π –ª–∞–Ω–¥—à–∞—Ñ—Ç
            ctx.fillStyle = '#7cb342';
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // –¢–µ–∫—Å—Ç—É—Ä–∞ —Ç—Ä–∞–≤—ã
            ctx.fillStyle = '#689f38';
            for (let i = 0; i < SCREEN_WIDTH; i += 20) {
                for (let j = 0; j < SCREEN_HEIGHT; j += 20) {
                    if ((i + j) % 40 === 0) {
                        ctx.fillRect(i, j, 10, 10);
                    }
                }
            }
            
            // –ö—Ä–µ–ø–æ—Å—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
            const castleX = SCREEN_WIDTH / 2;
            const castleY = SCREEN_HEIGHT / 2;
            
            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–º–∫–∞
            ctx.fillStyle = '#6d4c41';
            ctx.beginPath();
            ctx.arc(castleX, castleY, 80, 0, Math.PI * 2);
            ctx.fill();
            
            // –î–µ—Ç–∞–ª–∏ –∑–∞–º–∫–∞
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(castleX - 40, castleY - 60, 80, 40);
            ctx.fillRect(castleX - 60, castleY - 20, 120, 20);
            
            // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∑–∞–º–∫–∞
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(castleX - 50, castleY - 80, 100, 10);
            ctx.fillStyle = COLORS.HEALTH;
            ctx.fillRect(castleX - 50, castleY - 80, 100 * (gameState.playerHealth / gameState.maxCastleHealth), 10);
            
            // –Æ–Ω–∏—Ç—ã –∏–≥—Ä–æ–∫–∞
            gameState.units.forEach(unit => {
                // –Æ–Ω–∏—Ç
                if (images[unit.image]) {
                    ctx.drawImage(images[unit.image], unit.x - 30, unit.y - 30, 60, 60);
                } else {
                    // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    ctx.fillStyle = '#8d6e63';
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, 30, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#5d4037';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–Æ–ù–ò–¢', unit.x, unit.y + 5);
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —é–Ω–∏—Ç–∞
                ctx.fillStyle = '#5d4037';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60, 8);
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60 * (unit.health / unit.maxHealth), 8);
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (unit.state === 'attacking') {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#ef5350';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚öîÔ∏è', unit.x, unit.y - 50);
                } else if (unit.state === 'moving' || unit.state === 'chasing') {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#4fc3f7';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚û§', unit.x, unit.y - 50);
                }
            });
            
            // –í—Ä–∞–∂–µ—Å–∫–∏–µ —é–Ω–∏—Ç—ã
            gameState.enemyUnits.forEach(unit => {
                // –Æ–Ω–∏—Ç
                if (images[unit.image]) {
                    ctx.drawImage(images[unit.image], unit.x - 30, unit.y - 30, 60, 60);
                } else {
                    // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    ctx.fillStyle = '#5d4037';
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, 30, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#ef5350';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–í–†–ê–ì', unit.x, unit.y + 5);
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —é–Ω–∏—Ç–∞
                ctx.fillStyle = '#5d4037';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60, 8);
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60 * (unit.health / unit.maxHealth), 8);
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (unit.state === 'attacking') {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#ef5350';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚öîÔ∏è', unit.x, unit.y - 50);
                }
            });
            
            // –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Ä–æ–Ω–µ
            const now = Date.now();
            gameState.damagePopups.forEach(popup => {
                const progress = (now - popup.createdAt) / popup.life;
                const y = popup.y - progress * 50;
                const alpha = 1 - progress;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.font = 'bold 18px Arial';
                ctx.fillStyle = popup.color;
                ctx.textAlign = 'center';
                ctx.fillText(popup.text, popup.x, y);
                ctx.restore();
            });
            
            // –û–±–ª–∞—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ —Ñ–∞–∑–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏)
            if (gameState.gamePhase === 'preparation') {
                ctx.strokeStyle = 'rgba(79, 195, 247, 0.5)';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(castleX, castleY, 120, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                ctx.fillStyle = 'rgba(93, 64, 55, 0.8)';
                ctx.fillRect(castleX - 150, castleY + 100, 300, 40);
                ctx.fillStyle = '#f5e8c8';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —é–Ω–∏—Ç–æ–≤ –≤–æ–∫—Ä—É–≥ –∫—Ä–µ–ø–æ—Å—Ç–∏', castleX, castleY + 125);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ canvas
        function handleCanvasClick(x, y) {
            if (gameState.currentScreen !== 'game' || gameState.gameOver) return;
            
            // –í —Ñ–∞–∑–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—â–∞—Ç—å —é–Ω–∏—Ç–æ–≤
            if (gameState.gamePhase === 'preparation') {
                placeUnit(x, y);
            }
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updateGame();
            
            if (gameState.currentScreen === 'game') {
                renderGame();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ canvas
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            handleCanvasClick(x, y);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            handleCanvasClick(x, y);
        });

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        init();
    </script>
</body>
</html>
