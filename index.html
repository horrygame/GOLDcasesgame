<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Битва Крепостей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', serif;
        }
        
        body {
            background: linear-gradient(135deg, #3e2723, #5d4037);
            color: #f5e8c8;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            position: relative;
            width: 1200px;
            height: 800px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            overflow: hidden;
            border: 8px solid #5d4037;
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(61, 43, 31, 0.95);
            z-index: 10;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect fill="%235d4037" width="100" height="100"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%233e2723" stroke-width="2"/></svg>');
        }
        
        .hidden {
            display: none;
        }
        
        h1 {
            font-size: 64px;
            color: #d7ccc8;
            margin-bottom: 20px;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.7);
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 3px solid #8d6e63;
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 48px;
            color: #d7ccc8;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            text-align: center;
            font-weight: bold;
        }
        
        p {
            font-size: 24px;
            margin-bottom: 40px;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
            color: #efebe9;
        }
        
        .button {
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            color: #fff;
            border: none;
            padding: 15px 30px;
            font-size: 22px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            min-width: 250px;
            text-align: center;
            border: 2px solid #5d4037;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .button:hover {
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        
        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .button:disabled {
            background: linear-gradient(to bottom, #795548, #5d4037);
            cursor: not-allowed;
            transform: none;
            color: #bcaaa4;
        }
        
        .stats-panel {
            background: rgba(93, 64, 55, 0.8);
            padding: 15px 30px;
            border-radius: 5px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            color: #efebe9;
        }
        
        .menu-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            width: 90%;
        }
        
        .card {
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            padding: 20px;
            width: 300px;
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-common { border-color: #a1887f; background: rgba(121, 85, 72, 0.8); }
        .card-rare { border-color: #4fc3f7; background: rgba(33, 150, 243, 0.2); }
        .card-epic { border-color: #ba68c8; background: rgba(156, 39, 176, 0.2); }
        .card-mythic { border-color: #ffb74d; background: rgba(255, 167, 38, 0.2); }
        .card-legendary { border-color: #ffd54f; background: rgba(255, 193, 7, 0.2); }
        
        .card-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .character-icon {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            overflow: hidden;
            border: 2px solid #5d4037;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .character-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .character-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #f5e8c8;
            text-align: center;
        }
        
        .character-rarity {
            font-size: 14px;
            opacity: 0.9;
            font-weight: bold;
        }
        
        .character-description {
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
            color: #efebe9;
            line-height: 1.4;
        }
        
        .character-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .stat-item {
            font-size: 14px;
            color: #f5e8c8;
        }
        
        .character-ability {
            font-size: 14px;
            color: #ffd54f;
            margin-bottom: 10px;
            text-align: center;
            font-style: italic;
        }
        
        .character-status {
            margin-top: auto;
            font-size: 16px;
            font-weight: bold;
        }
        
        .owned { color: #81c784; }
        .locked { color: #e57373; }
        
        .upgrade-panel {
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            padding: 30px;
            width: 600px;
            margin-bottom: 30px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .upgrade-title {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            color: #f5e8c8;
            border-bottom: 1px solid #8d6e63;
            padding-bottom: 10px;
        }
        
        .upgrade-description {
            font-size: 16px;
            margin-bottom: 20px;
            color: #efebe9;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #5d4037;
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid #8d6e63;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8d6e63, #a1887f);
            border-radius: 5px;
        }
        
        .upgrade-stats {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            color: #f5e8c8;
        }
        
        .shop-items {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            overflow-x: auto;
            max-width: 100%;
            padding: 10px;
        }
        
        .shop-item {
            width: 120px;
            height: 100px;
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #5d4037;
            transition: all 0.3s;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .shop-item:hover {
            transform: scale(1.05);
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
        }
        
        .shop-item.disabled {
            background: linear-gradient(to bottom, #795548, #5d4037);
            cursor: not-allowed;
        }
        
        .shop-item-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .shop-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .shop-item-name {
            font-size: 12px;
            text-align: center;
            margin-bottom: 5px;
            color: #fff;
            font-weight: bold;
        }
        
        .shop-item-cost {
            font-size: 12px;
            color: #ffd54f;
            font-weight: bold;
        }
        
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        
        .ui-panel {
            background: rgba(93, 64, 55, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: #f5e8c8;
        }
        
        .game-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(61, 43, 31, 0.95);
            padding: 40px;
            border-radius: 5px;
            text-align: center;
            z-index: 20;
            border: 3px solid #8d6e63;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            width: 500px;
        }
        
        .case-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(61, 43, 31, 0.95);
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            z-index: 25;
            font-size: 20px;
            border: 2px solid #8d6e63;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            color: #f5e8c8;
        }
        
        .damage-popup {
            position: absolute;
            color: #ff5252;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            z-index: 15;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 1s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
        
        .tooltip {
            position: absolute;
            background: rgba(61, 43, 31, 0.95);
            color: #f5e8c8;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            max-width: 200px;
            z-index: 100;
            pointer-events: none;
            border: 1px solid #8d6e63;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(61, 43, 31, 0.95);
            color: #f5e8c8;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .energy-warning {
            color: #ff5252;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .difficulty-indicator {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(93, 64, 55, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 18px;
            z-index: 5;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: #f5e8c8;
        }
        
        /* Средневековые декоративные элементы */
        .medieval-border {
            border: 8px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z M10,10 L90,10 L90,90 L10,90 Z" fill="none" stroke="%238d6e63" stroke-width="4"/></svg>') 8 round;
        }
        
        .parchment {
            background: #f5e8c8;
            color: #5d4037;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #8d6e63;
        }
    </style>
</head>
<body>
    <div id="game-container" class="medieval-border">
        <canvas id="game-canvas" width="1200" height="800"></canvas>
        
        <!-- Главное меню -->
        <div id="main-menu" class="screen">
            <h1>⚔️ Битва Крепостей ⚔️</h1>
            <p class="parchment">Стратегическая битва за территории и ресурсы в эпоху рыцарей и замков</p>
            
            <div class="stats-panel">
                <div class="stat">💰 <span id="gold-stat">1000</span></div>
                <div class="stat">⚡ <span id="energy-stat">100</span></div>
                <div class="stat">🔑 <span id="keys-stat">5</span></div>
                <div class="stat">👥 <span id="chars-stat">1/15</span></div>
            </div>
            
            <div class="menu-buttons">
                <button class="button" id="characters-btn">👥 Персонажи</button>
                <button class="button" id="play-btn">🎮 Играть</button>
                <button class="button" id="production-btn">⛏️ Производство</button>
                <button class="button" id="upgrades-btn">⚡ Улучшения</button>
                <button class="button" id="cases-btn">🎁 Кейсы</button>
            </div>
        </div>
        
        <!-- Экран персонажей -->
        <div id="characters-screen" class="screen hidden">
            <h2>👥 Ваши персонажи</h2>
            <p class="parchment">Собирайте уникальных героев и улучшайте свою армию</p>
            
            <button class="button" id="characters-back-btn">← Назад</button>
            
            <div class="card-grid" id="characters-container">
                <!-- Карточки персонажей будут добавлены через JavaScript -->
            </div>
        </div>
        
        <!-- Экран производства -->
        <div id="production-screen" class="screen hidden">
            <h2>⛏️ Производство</h2>
            <p class="parchment">Управляйте своими ресурсами и производственными мощностями</p>
            
            <button class="button" id="production-back-btn">← Назад</button>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>💰 Золотая шахта</span>
                </div>
                <div class="upgrade-description">Производит: <span id="mine-production">1</span> золота/сек</div>
                <div class="upgrade-stats">Уровень: <span id="mine-level">1</span>/10</div>
                <button class="button" id="upgrade-mine-btn">Улучшить шахту (<span id="mine-upgrade-cost">100</span>💰)</button>
            </div>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>🔑 Производство ключей</span>
                </div>
                <div class="upgrade-description">Стоимость ключа: 1000💰</div>
                <p class="parchment">Ключи нужны для открытия кейсов с новыми персонажами</p>
                <div class="menu-buttons">
                    <button class="button" id="produce-1-key-btn">1 ключ</button>
                    <button class="button" id="produce-10-keys-btn">10 ключей</button>
                </div>
            </div>
        </div>
        
        <!-- Экран улучшений -->
        <div id="upgrades-screen" class="screen hidden">
            <h2>⚡ Улучшения</h2>
            <p class="parchment">Улучшайте характеристики своей крепости и армии</p>
            
            <button class="button" id="upgrades-back-btn">← Назад</button>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>⚡ Генератор энергии</span>
                    <span id="energy-upgrade-cost">150</span>💰
                </div>
                <div class="upgrade-description">Увеличивает скорость генерации энергии во время матчей</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="energy-progress" style="width: 10%"></div>
                </div>
                <div class="upgrade-stats">Уровень: <span id="energy-level">1</span>/10 | Генерация: <span id="energy-generation">1</span>/сек</div>
                <button class="button" id="upgrade-energy-btn">Улучшить генератор</button>
            </div>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>❤️ Укрепление замка</span>
                    <span id="castle-upgrade-cost">200</span>💰
                </div>
                <div class="upgrade-description">Увеличивает прочность вашей крепости</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="castle-progress" style="width: 10%"></div>
                </div>
                <div class="upgrade-stats">Уровень: <span id="castle-level">1</span>/10 | Здоровье: <span id="castle-health">100</span></div>
                <button class="button" id="upgrade-castle-btn">Укрепить замок</button>
            </div>
        </div>
        
        <!-- Экран кейсов -->
        <div id="cases-screen" class="screen hidden">
            <h2>🎁 Кейсы</h2>
            <p class="parchment">Открывайте кейсы для получения новых персонажей и бонусов</p>
            
            <button class="button" id="cases-back-btn">← Назад</button>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>🎁 Боевой кейс</span>
                </div>
                <div class="upgrade-stats">Доступные ключи: <span id="available-keys">5</span> 🔑</div>
                <p class="parchment">Шансы: Золото 75%, Обычный 15%, Редкий 6%, Эпический 3%, Мифический 0.9%, Легендарный 0.1%</p>
                <button class="button" id="open-case-btn">Открыть кейс (1🔑)</button>
            </div>
        </div>
        
        <!-- Игровой UI (отображается поверх игрового экрана) -->
        <div id="game-ui" class="game-ui hidden">
            <div class="ui-panel" id="energy-panel">
                ⚡ <span id="game-energy">0</span>
            </div>
            <div class="ui-panel">
                ❤️ <span id="game-health">100</span>
            </div>
            <div class="ui-panel">
                👹 <span id="game-enemy-health">1000</span>
            </div>
        </div>
        
        <!-- Индикатор сложности -->
        <div id="difficulty-indicator" class="difficulty-indicator hidden">
            Сложность: <span id="difficulty-level">1</span>
        </div>
        
        <!-- Результат игры -->
        <div id="game-result" class="game-result hidden">
            <h2 id="result-title">ПОБЕДА!</h2>
            <p id="result-message">+1 ключ, +50 золота</p>
            <button class="button" id="continue-btn">Продолжить</button>
        </div>
        
        <!-- Результат открытия кейса -->
        <div id="case-result" class="case-result hidden">
            <p id="case-result-message">🎉 Поздравляем! Вы получили нового персонажа!</p>
        </div>
    </div>

    <script>
        // Константы игры
        const SCREEN_WIDTH = 1200;
        const SCREEN_HEIGHT = 800;
        const FPS = 60;

        // Цвета в средневековом стиле
        const COLORS = {
            BACKGROUND: '#5d4037',
            GOLD: '#ffd54f',
            ENERGY: '#4fc3f7',
            HEALTH: '#ef5350',
            TEXT: '#f5e8c8',
            BUTTON: '#8d6e63',
            BUTTON_HOVER: '#a1887f',
            PANEL: 'rgba(93, 64, 55, 0.8)',
            CASTLE: '#6d4c41',
            BATTLEFIELD: '#7cb342',
            RARITY: {
                common: '#a1887f',
                rare: '#4fc3f7',
                epic: '#ba68c8',
                mythic: '#ffb74d',
                legendary: '#ffd54f'
            }
        };

        // Игровые данные
        const characters = {
            'white_guy': {
                'name': 'Белый Воин',
                'image': 'white_guy.png',
                'cost': 10,
                'health': 100,
                'damage': 20,
                'speed': 0.6,
                'attack_speed': 1.0,
                'attack_range': 80,
                'description': 'Базовый боец, сбалансированные характеристики',
                'rarity': 'common',
                'ability': null,
                'owned': true
            },
            'yellow_guy': {
                'name': 'Желтый Страж',
                'image': 'yellow_guy.png',
                'cost': 15,
                'health': 80,
                'damage': 25,
                'speed': 0.8,
                'attack_speed': 1.2,
                'attack_range': 70,
                'description': 'Быстрый атакующий',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'red_guy': {
                'name': 'Красный Берсерк',
                'image': 'red_guy.png',
                'cost': 20,
                'health': 120,
                'damage': 30,
                'speed': 0.4,
                'attack_speed': 0.8,
                'attack_range': 60,
                'description': 'Мощный удар, медленный',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'green_guy': {
                'name': 'Зеленый Лучник',
                'image': 'green_guy.png',
                'cost': 25,
                'health': 70,
                'damage': 35,
                'speed': 0.7,
                'attack_speed': 1.5,
                'attack_range': 120,
                'description': 'Дальний бой, высокая скорость',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'blue_guy': {
                'name': 'Синий Маг',
                'image': 'blue_guy.png',
                'cost': 30,
                'health': 60,
                'damage': 40,
                'speed': 0.3,
                'attack_speed': 0.7,
                'attack_range': 150,
                'description': 'Мощные заклинания',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'classic_rare_1': {
                'name': 'Теневой Убийца',
                'image': 'classic_rare_2.png',
                'cost': 50,
                'health': 90,
                'damage': 45,
                'speed': 0.9,
                'attack_speed': 1.8,
                'attack_range': 70,
                'description': 'Быстрый и смертоносный',
                'rarity': 'rare',
                'ability': 'Критический удар: шанс нанести двойной урон',
                'owned': false
            },
            'classic_rare_2': {
                'name': 'Рыцарь Света',
                'image': 'classic_rare_1.png',
                'cost': 55,
                'health': 150,
                'damage': 35,
                'speed': 0.5,
                'attack_speed': 1.0,
                'attack_range': 90,
                'description': 'Защитник с усиленной броней',
                'rarity': 'rare',
                'ability': 'Усиленная защита: +20% к здоровью',
                'owned': false
            },
            'classic_rare_3': {
                'name': 'Лесной Охотник',
                'image': 'classic_rare_3.png',
                'cost': 60,
                'health': 110,
                'damage': 40,
                'speed': 0.7,
                'attack_speed': 1.3,
                'attack_range': 130,
                'description': 'Меткий стрелок из лука',
                'rarity': 'rare',
                'ability': 'Двойной выстрел: иногда атакует дважды',
                'owned': false
            },
            'classic_rare_4': {
                'name': 'Горный Воин',
                'image': 'classic_rare_4.png',
                'cost': 65,
                'health': 180,
                'damage': 30,
                'speed': 0.3,
                'attack_speed': 0.9,
                'attack_range': 65,
                'description': 'Невероятно живучий боец',
                'rarity': 'rare',
                'ability': 'Живучесть: восстанавливает здоровье со временем',
                'owned': false
            },
            'classic_epic_1': {
                'name': 'Маг Огня',
                'image': 'classic_epic_1.png',
                'cost': 100,
                'health': 120,
                'damage': 60,
                'speed': 0.4,
                'attack_speed': 0.6,
                'attack_range': 160,
                'description': 'Поджигает врагов',
                'rarity': 'epic',
                'ability': 'Огненная аура: наносит урон всем врагам вблизи',
                'owned': false
            },
            'classic_epic_2': {
                'name': 'Феникс Воитель',
                'image': 'classic_myth_2.png',
                'cost': 110,
                'health': 180,
                'damage': 80,
                'speed': 0.6,
                'attack_speed': 1.2,
                'attack_range': 110,
                'description': 'Возрождается после смерти',
                'rarity': 'epic',
                'ability': 'Возрождение: с шансом 30% воскрешается с 50% здоровья',
                'owned': false
            },
            'classic_epic_3': {
                'name': 'Штормовой Призыватель',
                'image': 'classic_epic_3.png',
                'cost': 120,
                'health': 100,
                'damage': 55,
                'speed': 0.5,
                'attack_speed': 1.1,
                'attack_range': 140,
                'description': 'Призывает молнии',
                'rarity': 'epic',
                'ability': 'Электрический разряд: шанс оглушить врага',
                'owned': false
            },
            'classic_myth_1': {
                'name': 'Драконий Рыцарь',
                'image': 'classic_myth_1.png',
                'cost': 200,
                'health': 250,
                'damage': 70,
                'speed': 0.5,
                'attack_speed': 0.9,
                'attack_range': 100,
                'description': 'Дыхание дракона сжигает врагов',
                'rarity': 'mythic',
                'ability': 'Дыхание дракона: периодически наносит урон по площади',
                'owned': false
            },
            'classic_myth_2': {
                'name': 'Ледяной Страж',
                'image': 'classic_epic_2.png',
                'cost': 220,
                'health': 200,
                'damage': 35,
                'speed': 0.3,
                'attack_speed': 0.8,
                'attack_range': 80,
                'description': 'Замедляет врагов',
                'rarity': 'mythic',
                'ability': 'Ледяная броня: замедляет атакующих его врагов',
                'owned': false
            },
            'classic_leg': {
                'name': 'Владыка Битвы',
                'image': 'classic_leg.png',
                'cost': 500,
                'health': 400,
                'damage': 100,
                'speed': 0.7,
                'attack_speed': 1.5,
                'attack_range': 120,
                'description': 'Легендарный воин с божественной силой',
                'rarity': 'legendary',
                'ability': 'Божественная ярость: при низком здоровье урон увеличивается вдвое',
                'owned': false
            }
        };

        const enemyTypes = [
            {health: 80, damage: 15, speed: 0.6, attack_speed: 1.0, attack_range: 70, image: 'white_guy.png'},
            {health: 50, damage: 25, speed: 0.8, attack_speed: 1.2, attack_range: 90, image: 'yellow_guy.png'},
            {health: 120, damage: 10, speed: 0.4, attack_speed: 0.8, attack_range: 60, image: 'red_guy.png'}
        ];

        // Игровое состояние
        let gameState = {
            currentScreen: 'main_menu',
            gold: 1000,
            energy: 100,
            playerHealth: 100,
            maxCastleHealth: 100,
            enemyHealth: 1000,
            mineLevel: 1,
            mineProduction: 1,
            mineUpgradeCost: 100,
            energyGenLevel: 1,
            energyGeneration: 1,
            energyGenUpgradeCost: 150,
            castleLevel: 1,
            castleUpgradeCost: 200,
            keys: 5,
            ownedCharacters: ['white_guy'],
            units: [],
            enemyUnits: [],
            enemySpawnTimer: 0,
            unitCounter: 0,
            enemyCounter: 0,
            lastGoldUpdate: 0,
            lastEnergyUpdate: 0,
            gameOver: false,
            gameResult: null,
            damagePopups: [],
            difficulty: 1,
            gamesPlayed: 0,
            gamesWon: 0
        };

        // Получение элементов DOM
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        const screens = {
            main_menu: document.getElementById('main-menu'),
            characters: document.getElementById('characters-screen'),
            game: null, // Игровой экран рисуется на canvas
            production: document.getElementById('production-screen'),
            upgrades: document.getElementById('upgrades-screen'),
            cases: document.getElementById('cases-screen')
        };

        // Кнопки
        const buttons = {
            // Главное меню
            characters: document.getElementById('characters-btn'),
            play: document.getElementById('play-btn'),
            production: document.getElementById('production-btn'),
            upgrades: document.getElementById('upgrades-btn'),
            cases: document.getElementById('cases-btn'),
            
            // Назад
            charactersBack: document.getElementById('characters-back-btn'),
            productionBack: document.getElementById('production-back-btn'),
            upgradesBack: document.getElementById('upgrades-back-btn'),
            casesBack: document.getElementById('cases-back-btn'),
            
            // Производство
            upgradeMine: document.getElementById('upgrade-mine-btn'),
            produce1Key: document.getElementById('produce-1-key-btn'),
            produce10Keys: document.getElementById('produce-10-keys-btn'),
            
            // Улучшения
            upgradeEnergy: document.getElementById('upgrade-energy-btn'),
            upgradeCastle: document.getElementById('upgrade-castle-btn'),
            
            // Кейсы
            openCase: document.getElementById('open-case-btn'),
            
            // Игра
            continue: document.getElementById('continue-btn')
        };

        // Статистика
        const stats = {
            gold: document.getElementById('gold-stat'),
            energy: document.getElementById('energy-stat'),
            keys: document.getElementById('keys-stat'),
            chars: document.getElementById('chars-stat'),
            
            // Производство
            mineProduction: document.getElementById('mine-production'),
            mineLevel: document.getElementById('mine-level'),
            mineUpgradeCost: document.getElementById('mine-upgrade-cost'),
            
            // Улучшения
            energyLevel: document.getElementById('energy-level'),
            energyGeneration: document.getElementById('energy-generation'),
            energyUpgradeCost: document.getElementById('energy-upgrade-cost'),
            energyProgress: document.getElementById('energy-progress'),
            castleLevel: document.getElementById('castle-level'),
            castleHealth: document.getElementById('castle-health'),
            castleUpgradeCost: document.getElementById('castle-upgrade-cost'),
            castleProgress: document.getElementById('castle-progress'),
            
            // Кейсы
            availableKeys: document.getElementById('available-keys'),
            
            // Игра
            gameEnergy: document.getElementById('game-energy'),
            gameHealth: document.getElementById('game-health'),
            gameEnemyHealth: document.getElementById('game-enemy-health')
        };

        // Результаты
        const gameResult = document.getElementById('game-result');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const caseResult = document.getElementById('case-result');
        const caseResultMessage = document.getElementById('case-result-message');

        // Игровой UI
        const gameUI = document.getElementById('game-ui');
        const energyPanel = document.getElementById('energy-panel');
        const difficultyIndicator = document.getElementById('difficulty-indicator');
        const difficultyLevel = document.getElementById('difficulty-level');

        // Загруженные изображения
        const images = {};

        // Инициализация игры
        function init() {
            // Загрузка изображений
            loadImages().then(() => {
                // Настройка кнопок
                setupButtons();
                
                // Обновление статистики
                updateStats();
                
                // Запуск игрового цикла
                gameLoop();
            });
        }

        // Загрузка изображений
        function loadImages() {
            const promises = [];
            
            // Загрузка изображений персонажей
            Object.values(characters).forEach(character => {
                promises.push(loadImage(character.image));
            });
            
            // Загрузка изображений врагов
            enemyTypes.forEach(enemy => {
                promises.push(loadImage(enemy.image));
            });
            
            return Promise.all(promises);
        }

        // Загрузка отдельного изображения
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    images[src] = img;
                    resolve();
                };
                img.onerror = () => {
                    // Создаем заглушку если изображение не загружено
                    const canvas = document.createElement('canvas');
                    canvas.width = 60;
                    canvas.height = 60;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(0, 0, 60, 60);
                    ctx.fillStyle = '#5d4037';
                    ctx.font = '10px Arial';
                    ctx.fillText('IMG', 20, 30);
                    images[src] = canvas;
                    resolve();
                };
                img.src = src;
            });
        }

        // Настройка обработчиков кнопок
        function setupButtons() {
            // Главное меню
            buttons.characters.addEventListener('click', () => showScreen('characters'));
            buttons.play.addEventListener('click', startGame);
            buttons.production.addEventListener('click', () => showScreen('production'));
            buttons.upgrades.addEventListener('click', () => showScreen('upgrades'));
            buttons.cases.addEventListener('click', () => showScreen('cases'));
            
            // Кнопки назад
            buttons.charactersBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.productionBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.upgradesBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.casesBack.addEventListener('click', () => {
                showScreen('main_menu');
                hideCaseResult();
            });
            
            // Производство
            buttons.upgradeMine.addEventListener('click', upgradeMine);
            buttons.produce1Key.addEventListener('click', () => produceKeys(1));
            buttons.produce10Keys.addEventListener('click', () => produceKeys(10));
            
            // Улучшения
            buttons.upgradeEnergy.addEventListener('click', upgradeEnergyGeneration);
            buttons.upgradeCastle.addEventListener('click', upgradeCastle);
            
            // Кейсы
            buttons.openCase.addEventListener('click', openCase);
            
            // Игра
            buttons.continue.addEventListener('click', () => {
                gameResult.classList.add('hidden');
                showScreen('main_menu');
            });
        }

        // Показать экран
        function showScreen(screenName) {
            // Скрыть все экраны
            Object.values(screens).forEach(screen => {
                if (screen) screen.classList.add('hidden');
            });
            
            // Скрыть игровой UI
            gameUI.classList.add('hidden');
            difficultyIndicator.classList.add('hidden');
            
            // Показать выбранный экран
            if (screenName === 'game') {
                // Игровой экран рисуется на canvas
                gameUI.classList.remove('hidden');
                difficultyIndicator.classList.remove('hidden');
            } else if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
            
            gameState.currentScreen = screenName;
            
            // Обновление контента экрана
            if (screenName === 'characters') {
                renderCharactersScreen();
            } else if (screenName === 'production' || screenName === 'upgrades' || 
                      screenName === 'cases' || screenName === 'main_menu') {
                updateStats();
            }
        }

        // Обновление статистики
        function updateStats() {
            // Главное меню
            stats.gold.textContent = gameState.gold;
            stats.energy.textContent = gameState.energy;
            stats.keys.textContent = gameState.keys;
            stats.chars.textContent = `${gameState.ownedCharacters.length}/${Object.keys(characters).length}`;
            
            // Производство
            stats.mineProduction.textContent = gameState.mineProduction;
            stats.mineLevel.textContent = gameState.mineLevel;
            stats.mineUpgradeCost.textContent = gameState.mineUpgradeCost;
            
            // Улучшения
            stats.energyLevel.textContent = gameState.energyGenLevel;
            stats.energyGeneration.textContent = gameState.energyGeneration;
            stats.energyUpgradeCost.textContent = gameState.energyGenUpgradeCost;
            stats.energyProgress.style.width = `${(gameState.energyGenLevel / 10) * 100}%`;
            
            stats.castleLevel.textContent = gameState.castleLevel;
            stats.castleHealth.textContent = gameState.maxCastleHealth;
            stats.castleUpgradeCost.textContent = gameState.castleUpgradeCost;
            stats.castleProgress.style.width = `${(gameState.castleLevel / 10) * 100}%`;
            
            // Кейсы
            stats.availableKeys.textContent = gameState.keys;
            
            // Игра
            stats.gameEnergy.textContent = gameState.energy;
            stats.gameHealth.textContent = gameState.playerHealth;
            stats.gameEnemyHealth.textContent = gameState.enemyHealth;
            
            // Сложность
            difficultyLevel.textContent = gameState.difficulty;
            
            // Обновление состояния кнопок улучшений
            updateUpgradeButtons();
        }

        // Обновление состояния кнопок улучшений
        function updateUpgradeButtons() {
            // Шахта
            buttons.upgradeMine.disabled = gameState.gold < gameState.mineUpgradeCost || gameState.mineLevel >= 10;
            if (gameState.mineLevel >= 10) {
                buttons.upgradeMine.textContent = "Макс. уровень";
            } else {
                buttons.upgradeMine.textContent = `Улучшить шахту (${gameState.mineUpgradeCost}💰)`;
            }
            
            // Генератор энергии
            buttons.upgradeEnergy.disabled = gameState.gold < gameState.energyGenUpgradeCost || gameState.energyGenLevel >= 10;
            if (gameState.energyGenLevel >= 10) {
                buttons.upgradeEnergy.textContent = "Макс. уровень";
            } else {
                buttons.upgradeEnergy.textContent = "Улучшить генератор";
            }
            
            // Замок
            buttons.upgradeCastle.disabled = gameState.gold < gameState.castleUpgradeCost || gameState.castleLevel >= 10;
            if (gameState.castleLevel >= 10) {
                buttons.upgradeCastle.textContent = "Макс. уровень";
            } else {
                buttons.upgradeCastle.textContent = "Укрепить замок";
            }
            
            // Кейсы
            buttons.openCase.disabled = gameState.keys <= 0;
            
            // Производство ключей
            buttons.produce1Key.disabled = gameState.gold < 1000;
            buttons.produce10Keys.disabled = gameState.gold < 10000;
        }

        // Рендер экрана персонажей
        function renderCharactersScreen() {
            const container = document.getElementById('characters-container');
            container.innerHTML = '';
            
            // Сортировка персонажей по редкости
            const sortedChars = Object.entries(characters).sort((a, b) => {
                const rarityOrder = ['common', 'rare', 'epic', 'mythic', 'legendary'];
                return rarityOrder.indexOf(b[1].rarity) - rarityOrder.indexOf(a[1].rarity);
            });
            
            sortedChars.forEach(([charId, char]) => {
                const card = document.createElement('div');
                card.className = `card card-${char.rarity}`;
                
                const isOwned = gameState.ownedCharacters.includes(charId);
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="character-icon">
                            <img src="${char.image}" alt="${char.name}">
                        </div>
                        <div class="character-name">${char.name}</div>
                        <div class="character-rarity">${char.rarity.toUpperCase()}</div>
                    </div>
                    <div class="character-description">${char.description}</div>
                    ${char.ability ? `<div class="character-ability">${char.ability}</div>` : ''}
                    <div class="character-stats">
                        <div class="stat-item">❤️ ${char.health}</div>
                        <div class="stat-item">⚔️ ${char.damage}</div>
                        <div class="stat-item">👟 ${char.speed}</div>
                        <div class="stat-item">📏 ${char.attack_range}</div>
                        <div class="stat-item">⚡ ${char.cost}</div>
                    </div>
                    <div class="character-status ${isOwned ? 'owned' : 'locked'}">
                        ${isOwned ? '✅ В вашей коллекции' : '🔒 Не получен'}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Начать игру
        function startGame() {
            // Сброс состояния игры
            gameState.playerHealth = gameState.maxCastleHealth;
            
            // Балансировка здоровья вражеского замка в зависимости от сложности
            const baseEnemyHealth = 500;
            const difficultyMultiplier = 1 + (gameState.difficulty - 1) * 0.2;
            gameState.enemyHealth = Math.floor(baseEnemyHealth * difficultyMultiplier);
            
            gameState.energy = 50; // Начальная энергия увеличена для баланса
            gameState.units = [];
            gameState.enemyUnits = [];
            gameState.enemySpawnTimer = 0;
            gameState.unitCounter = 0;
            gameState.enemyCounter = 0;
            gameState.gameOver = false;
            gameState.gameResult = null;
            gameState.damagePopups = [];
            
            showScreen('game');
        }

        // Спавн юнита
        function spawnUnit(characterId) {
            const character = characters[characterId];
            if (gameState.energy >= character.cost && gameState.ownedCharacters.includes(characterId)) {
                gameState.energy -= character.cost;
                gameState.unitCounter++;
                gameState.units.push({
                    id: `unit_${gameState.unitCounter}`,
                    characterId: characterId,
                    x: 300,
                    health: character.health,
                    maxHealth: character.health,
                    damage: character.damage,
                    speed: character.speed,
                    attackSpeed: character.attack_speed,
                    attackRange: character.attack_range,
                    image: character.image,
                    isFighting: false,
                    target: null,
                    lastAttackTime: 0,
                    isAttacking: false
                });
                
                // Визуальная обратная связь
                createDamagePopup(300, SCREEN_HEIGHT - 280, `-${character.cost}⚡`, '#4fc3f7');
                
                return true;
            } else {
                // Визуальная обратная связь при недостатке энергии
                if (gameState.energy < character.cost) {
                    energyPanel.classList.add('energy-warning');
                    setTimeout(() => {
                        energyPanel.classList.remove('energy-warning');
                    }, 1000);
                    
                    createDamagePopup(300, SCREEN_HEIGHT - 280, "Недостаточно энергии!", '#ef5350');
                }
                return false;
            }
        }

        // Спавн вражеского юнита
        function spawnEnemyUnit() {
            // Балансировка врагов в зависимости от сложности
            const difficultyMultiplier = 1 + (gameState.difficulty - 1) * 0.1;
            
            const enemy = {...enemyTypes[Math.floor(Math.random() * enemyTypes.length)]};
            
            // Увеличиваем характеристики врагов в зависимости от сложности
            enemy.health = Math.floor(enemy.health * difficultyMultiplier);
            enemy.damage = Math.floor(enemy.damage * difficultyMultiplier);
            
            gameState.enemyCounter++;
            gameState.enemyUnits.push({
                id: `enemy_${gameState.enemyCounter}`,
                x: SCREEN_WIDTH - 300,
                health: enemy.health,
                maxHealth: enemy.health,
                damage: enemy.damage,
                speed: enemy.speed,
                attackSpeed: enemy.attack_speed,
                attackRange: enemy.attack_range,
                image: enemy.image,
                isFighting: false,
                target: null,
                lastAttackTime: 0,
                isAttacking: false
            });
        }

        // Создание всплывающего сообщения об уроне
        function createDamagePopup(x, y, text, color) {
            gameState.damagePopups.push({
                x: x,
                y: y,
                text: text,
                color: color,
                life: 1000,
                createdAt: Date.now()
            });
        }

        // Обновление юнитов
        function updateUnits() {
            const now = Date.now();
            
            // Движение игровых юнитов
            gameState.units.forEach(unit => {
                const character = characters[unit.characterId];
                const reachedEnemyCastle = unit.x >= SCREEN_WIDTH - 400;
                
                // Поиск вражеских юнитов в радиусе атаки
                let enemyInRange = null;
                for (const enemy of gameState.enemyUnits) {
                    if (Math.abs(unit.x - enemy.x) <= unit.attackRange && enemy.health > 0) {
                        enemyInRange = enemy;
                        break;
                    }
                }
                
                if (enemyInRange) {
                    // Бой с вражеским юнитом
                    unit.isFighting = true;
                    unit.target = enemyInRange;
                    
                    // Атака вражеского юнита
                    if (!unit.lastAttackTime || now - unit.lastAttackTime > (1000 / unit.attackSpeed)) {
                        enemyInRange.health -= unit.damage;
                        unit.lastAttackTime = now;
                        unit.isAttacking = true;
                        
                        // Создание всплывающего урона
                        createDamagePopup(enemyInRange.x + 30, SCREEN_HEIGHT - 280, `-${unit.damage}`, '#ef5350');
                        
                        if (enemyInRange.health <= 0) {
                            gameState.enemyUnits = gameState.enemyUnits.filter(u => u !== enemyInRange);
                            unit.isFighting = false;
                            unit.target = null;
                        }
                    }
                } else if (reachedEnemyCastle) {
                    // Атака вражеской крепости
                    unit.isFighting = true;
                    
                    if (!unit.lastAttackTime || now - unit.lastAttackTime > (1000 / unit.attackSpeed)) {
                        gameState.enemyHealth -= unit.damage;
                        unit.lastAttackTime = now;
                        unit.isAttacking = true;
                        
                        // Создание всплывающего урона
                        createDamagePopup(SCREEN_WIDTH - 200, SCREEN_HEIGHT - 450, `-${unit.damage}`, '#ef5350');
                    }
                } else {
                    // Свободное движение
                    unit.isFighting = false;
                    unit.target = null;
                    unit.x += unit.speed;
                }
            });
            
            // Движение вражеских юнитов
            gameState.enemyUnits.forEach(unit => {
                const reachedPlayerCastle = unit.x <= 400;
                
                // Поиск игровых юнитов в радиусе атаки
                let playerInRange = null;
                for (const playerUnit of gameState.units) {
                    if (Math.abs(unit.x - playerUnit.x) <= unit.attackRange && playerUnit.health > 0) {
                        playerInRange = playerUnit;
                        break;
                    }
                }
                
                if (playerInRange) {
                    // Бой с игровым юнитом
                    unit.isFighting = true;
                    unit.target = playerInRange;
                    
                    // Атака игрового юнита
                    if (!unit.lastAttackTime || now - unit.lastAttackTime > (1000 / unit.attackSpeed)) {
                        playerInRange.health -= unit.damage;
                        unit.lastAttackTime = now;
                        unit.isAttacking = true;
                        
                        // Создание всплывающего урона
                        createDamagePopup(playerInRange.x + 30, SCREEN_HEIGHT - 280, `-${unit.damage}`, '#ef5350');
                        
                        if (playerInRange.health <= 0) {
                            gameState.units = gameState.units.filter(u => u !== playerInRange);
                            unit.isFighting = false;
                            unit.target = null;
                        }
                    }
                } else if (reachedPlayerCastle) {
                    // Атака игровой крепости
                    unit.isFighting = true;
                    
                    if (!unit.lastAttackTime || now - unit.lastAttackTime > (1000 / unit.attackSpeed)) {
                        gameState.playerHealth -= unit.damage;
                        unit.lastAttackTime = now;
                        unit.isAttacking = true;
                        
                        // Создание всплывающего урона
                        createDamagePopup(200, SCREEN_HEIGHT - 450, `-${unit.damage}`, '#ef5350');
                    }
                } else {
                    // Свободное движение
                    unit.isFighting = false;
                    unit.target = null;
                    unit.x -= unit.speed;
                }
            });
            
            // Удаление мертвых юнитов
            gameState.units = gameState.units.filter(unit => unit.health > 0);
            gameState.enemyUnits = gameState.enemyUnits.filter(unit => unit.health > 0);
            
            // Обновление всплывающих сообщений об уроне
            gameState.damagePopups = gameState.damagePopups.filter(popup => {
                return now - popup.createdAt < popup.life;
            });
        }

        // Обновление игры
        function updateGame() {
            const currentTime = Date.now();
            
            // Пассивный доход золота
            if (currentTime - gameState.lastGoldUpdate > 1000) {
                gameState.gold += gameState.mineProduction;
                gameState.lastGoldUpdate = currentTime;
                updateStats();
            }
            
            // Если мы в игре, обновляем состояние игры
            if (gameState.currentScreen === 'game' && !gameState.gameOver) {
                // Генерация энергии в матче
                if (currentTime - gameState.lastEnergyUpdate > 1000) {
                    gameState.energy += gameState.energyGeneration;
                    gameState.lastEnergyUpdate = currentTime;
                    updateStats();
                }
                
                // Спавн вражеских юнитов (интервал зависит от сложности)
                gameState.enemySpawnTimer += 1000 / FPS;
                
                // Балансировка интервала спавна врагов
                const baseSpawnInterval = 5000; // 5 секунд
                const difficultySpawnMultiplier = 1 - (gameState.difficulty - 1) * 0.1;
                const spawnInterval = Math.max(2000, baseSpawnInterval * difficultySpawnMultiplier);
                
                if (gameState.enemySpawnTimer >= spawnInterval) {
                    spawnEnemyUnit();
                    gameState.enemySpawnTimer = 0;
                }
                
                // Обновление позиций и атак юнитов
                updateUnits();
                
                // Проверка конца игры
                if (gameState.playerHealth <= 0 || gameState.enemyHealth <= 0) {
                    gameState.gameOver = true;
                    gameState.gamesPlayed++;
                    
                    if (gameState.playerHealth <= 0) {
                        gameState.gameResult = 'lose';
                        resultTitle.textContent = 'ПОРАЖЕНИЕ';
                        resultMessage.textContent = 'Попробуйте еще раз!';
                        
                        // Уменьшаем сложность после поражения (но не ниже 1)
                        gameState.difficulty = Math.max(1, gameState.difficulty - 1);
                    } else {
                        gameState.gameResult = 'win';
                        resultTitle.textContent = 'ПОБЕДА!';
                        resultMessage.textContent = '+1 ключ, +50 золота';
                        
                        // Награда за победу
                        gameState.keys += 1;
                        gameState.gold += 50;
                        gameState.gamesWon++;
                        
                        // Увеличиваем сложность после победы
                        gameState.difficulty++;
                    }
                    gameResult.classList.remove('hidden');
                    updateStats();
                }
            }
        }

        // Улучшения
        function upgradeMine() {
            if (gameState.gold >= gameState.mineUpgradeCost && gameState.mineLevel < 10) {
                gameState.gold -= gameState.mineUpgradeCost;
                gameState.mineLevel += 1;
                gameState.mineProduction += 1;
                gameState.mineUpgradeCost = Math.floor(gameState.mineUpgradeCost * 1.5);
                updateStats();
                
                // Визуальная обратная связь
                showNotification(`Шахта улучшена до уровня ${gameState.mineLevel}!`);
            }
        }

        function produceKeys(amount) {
            const cost = amount * 1000;
            if (gameState.gold >= cost) {
                gameState.gold -= cost;
                gameState.keys += amount;
                updateStats();
                
                // Визуальная обратная связь
                showNotification(`Произведено ${amount} ключей!`);
            }
        }

        function upgradeEnergyGeneration() {
            if (gameState.gold >= gameState.energyGenUpgradeCost && gameState.energyGenLevel < 10) {
                gameState.gold -= gameState.energyGenUpgradeCost;
                gameState.energyGenLevel += 1;
                gameState.energyGeneration += 0.5;
                gameState.energyGenUpgradeCost = Math.floor(gameState.energyGenUpgradeCost * 1.5);
                updateStats();
                
                // Визуальная обратная связь
                showNotification(`Генератор улучшен до уровня ${gameState.energyGenLevel}!`);
            }
        }

        function upgradeCastle() {
            if (gameState.gold >= gameState.castleUpgradeCost && gameState.castleLevel < 10) {
                gameState.gold -= gameState.castleUpgradeCost;
                gameState.castleLevel += 1;
                gameState.maxCastleHealth += 20;
                gameState.castleUpgradeCost = Math.floor(gameState.castleUpgradeCost * 1.5);
                updateStats();
                
                // Визуальная обратная связь
                showNotification(`Замок укреплен до уровня ${gameState.castleLevel}!`);
            }
        }

        function openCase() {
            if (gameState.keys > 0) {
                gameState.keys -= 1;
                updateStats();
                
                // Новые шансы выпадения: 75% золото, 25% персонаж
                const rarityRoll = Math.random();
                let targetRarity;
                
                if (rarityRoll < 0.75) {
                    // 75% шанс выпадения золота
                    const goldReward = Math.floor(Math.random() * 401) + 100;
                    gameState.gold += goldReward;
                    showCaseResult(`💰 Вы получили ${goldReward} золота!`);
                    updateStats();
                    return;
                }
                
                // 25% шанс выпадения персонажа
                const characterRoll = Math.random();
                if (characterRoll < 0.01) { // 0.1% легендарный (от 25%)
                    targetRarity = 'legendary';
                } else if (characterRoll < 0.046) { // 3.6% мифический (от 25%)
                    targetRarity = 'mythic';
                } else if (characterRoll < 0.166) { // 12% эпический (от 25%)
                    targetRarity = 'epic';
                } else if (characterRoll < 0.406) { // 24% редкий (от 25%)
                    targetRarity = 'rare';
                } else { // 60% обычный (от 25%)
                    targetRarity = 'common';
                }
                
                // Доступные персонажи этой редкости
                const availableChars = Object.keys(characters).filter(charId => 
                    !gameState.ownedCharacters.includes(charId) && characters[charId].rarity === targetRarity
                );
                
                let resultMessage;
                if (availableChars.length > 0) {
                    // Выпадение нового персонажа
                    const randomCharId = availableChars[Math.floor(Math.random() * availableChars.length)];
                    gameState.ownedCharacters.push(randomCharId);
                    characters[randomCharId].owned = true;
                    resultMessage = `🎉 Поздравляем! Вы получили ${characters[randomCharId].name} (${targetRarity.toUpperCase()})!`;
                    
                    // Автоматическое обновление экрана персонажей
                    if (gameState.currentScreen === 'cases') {
                        setTimeout(() => {
                            renderCharactersScreen();
                        }, 100);
                    }
                } else {
                    // Если все персонажи этой редкости уже есть, выпадает золото
                    const goldReward = Math.floor(Math.random() * 401) + 100;
                    gameState.gold += goldReward;
                    resultMessage = `💰 Вы получили ${goldReward} золота!`;
                }
                
                showCaseResult(resultMessage);
                updateStats();
            }
        }

        // Показать уведомление
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showCaseResult(message) {
            caseResultMessage.textContent = message;
            caseResult.classList.remove('hidden');
        }

        function hideCaseResult() {
            caseResult.classList.add('hidden');
        }

        // Рендер игры
        function renderGame() {
            // Очистка canvas
            ctx.fillStyle = COLORS.BACKGROUND;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Поле боя - средневековый ландшафт
            ctx.fillStyle = '#7cb342';
            ctx.fillRect(0, SCREEN_HEIGHT - 150, SCREEN_WIDTH, 150);
            
            // Текстура травы
            ctx.fillStyle = '#689f38';
            for (let i = 0; i < SCREEN_WIDTH; i += 20) {
                ctx.fillRect(i, SCREEN_HEIGHT - 150, 10, 10);
            }
            
            // Замки
            // Замок игрока
            ctx.fillStyle = '#6d4c41';
            ctx.fillRect(100, SCREEN_HEIGHT - 400, 200, 250);
            ctx.strokeStyle = '#5d4037';
            ctx.lineWidth = 5;
            ctx.strokeRect(100, SCREEN_HEIGHT - 400, 200, 250);
            
            // Детали замка игрока
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(180, SCREEN_HEIGHT - 450, 40, 50); // Башня
            ctx.fillRect(120, SCREEN_HEIGHT - 380, 40, 30); // Окно
            ctx.fillRect(240, SCREEN_HEIGHT - 380, 40, 30); // Окно
            
            // Полоска здоровья замка игрока
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(100, SCREEN_HEIGHT - 440, 200, 20);
            ctx.fillStyle = COLORS.HEALTH;
            ctx.fillRect(100, SCREEN_HEIGHT - 440, 200 * (gameState.playerHealth / gameState.maxCastleHealth), 20);
            
            // Замок врага
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(SCREEN_WIDTH - 300, SCREEN_HEIGHT - 400, 200, 250);
            ctx.strokeStyle = '#4e342e';
            ctx.lineWidth = 5;
            ctx.strokeRect(SCREEN_WIDTH - 300, SCREEN_HEIGHT - 400, 200, 250);
            
            // Детали замка врага
            ctx.fillStyle = '#795548';
            ctx.fillRect(SCREEN_WIDTH - 220, SCREEN_HEIGHT - 450, 40, 50); // Башня
            ctx.fillRect(SCREEN_WIDTH - 280, SCREEN_HEIGHT - 380, 40, 30); // Окно
            ctx.fillRect(SCREEN_WIDTH - 160, SCREEN_HEIGHT - 380, 40, 30); // Окно
            
            // Полоска здоровья замка врага
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(SCREEN_WIDTH - 300, SCREEN_HEIGHT - 440, 200, 20);
            ctx.fillStyle = '#ef5350';
            ctx.fillRect(SCREEN_WIDTH - 300, SCREEN_HEIGHT - 440, 200 * (gameState.enemyHealth / (500 * (1 + (gameState.difficulty - 1) * 0.2))), 20);
            
            // Юниты
            gameState.units.forEach(unit => {
                // Юнит
                if (images[unit.image]) {
                    ctx.drawImage(images[unit.image], unit.x, SCREEN_HEIGHT - 230, 60, 60);
                } else {
                    // Запасной вариант если изображение не загружено
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(unit.x, SCREEN_HEIGHT - 230, 60, 60);
                    ctx.fillStyle = '#5d4037';
                    ctx.font = '10px Arial';
                    ctx.fillText('ЮНИТ', unit.x + 15, SCREEN_HEIGHT - 200);
                }
                
                // Полоска здоровья юнита
                ctx.fillStyle = '#5d4037';
                ctx.fillRect(unit.x, SCREEN_HEIGHT - 240, 60, 8);
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(unit.x, SCREEN_HEIGHT - 240, 60 * (unit.health / unit.maxHealth), 8);
                
                // Индикатор боя
                if (unit.isFighting) {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#ef5350';
                    ctx.fillText('⚔️ БОЙ', unit.x + 10, SCREEN_HEIGHT - 250);
                }
            });
            
            // Вражеские юниты
            gameState.enemyUnits.forEach(unit => {
                // Юнит
                if (images[unit.image]) {
                    ctx.drawImage(images[unit.image], unit.x, SCREEN_HEIGHT - 230, 60, 60);
                } else {
                    // Запасной вариант если изображение не загружено
                    ctx.fillStyle = '#5d4037';
                    ctx.fillRect(unit.x, SCREEN_HEIGHT - 230, 60, 60);
                    ctx.fillStyle = '#ef5350';
                    ctx.font = '10px Arial';
                    ctx.fillText('ВРАГ', unit.x + 15, SCREEN_HEIGHT - 200);
                }
                
                // Полоска здоровья юнита
                ctx.fillStyle = '#5d4037';
                ctx.fillRect(unit.x, SCREEN_HEIGHT - 240, 60, 8);
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(unit.x, SCREEN_HEIGHT - 240, 60 * (unit.health / unit.maxHealth), 8);
                
                // Индикатор боя
                if (unit.isFighting) {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#ef5350';
                    ctx.fillText('⚔️ БОЙ', unit.x + 10, SCREEN_HEIGHT - 250);
                }
            });
            
            // Всплывающие сообщения об уроне
            const now = Date.now();
            gameState.damagePopups.forEach(popup => {
                const progress = (now - popup.createdAt) / popup.life;
                const y = popup.y - progress * 50;
                const alpha = 1 - progress;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.font = 'bold 18px Arial';
                ctx.fillStyle = popup.color;
                ctx.textAlign = 'center';
                ctx.fillText(popup.text, popup.x, y);
                ctx.restore();
            });
            
            // Магазин
            ctx.fillStyle = 'rgba(93, 64, 55, 0.9)';
            ctx.fillRect(SCREEN_WIDTH / 2 - 300, SCREEN_HEIGHT - 140, 600, 120);
            ctx.strokeStyle = '#8d6e63';
            ctx.lineWidth = 2;
            ctx.strokeRect(SCREEN_WIDTH / 2 - 300, SCREEN_HEIGHT - 140, 600, 120);
            
            const shopItemWidth = 120;
            const shopMargin = 20;
            const shopStartX = SCREEN_WIDTH / 2 - 300 + shopMargin;
            
            // Отрисовка предметов магазина
            for (let i = 0; i < gameState.ownedCharacters.length; i++) {
                const charId = gameState.ownedCharacters[i];
                const character = characters[charId];
                const x = shopStartX + i * (shopItemWidth + shopMargin);
                const rarityColor = COLORS.RARITY[character.rarity];
                
                // Фон предмета магазина
                const itemColor = gameState.energy >= character.cost ? rarityColor : '#795548';
                ctx.fillStyle = itemColor;
                ctx.fillRect(x, SCREEN_HEIGHT - 130, shopItemWidth, 100);
                ctx.strokeStyle = '#5d4037';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, SCREEN_HEIGHT - 130, shopItemWidth, 100);
                
                // Изображение персонажа
                if (images[character.image]) {
                    ctx.drawImage(images[character.image], x + shopItemWidth / 2 - 20, SCREEN_HEIGHT - 120, 40, 40);
                }
                
                // Название
                ctx.font = '12px Arial';
                ctx.fillStyle = '#f5e8c8';
                ctx.fillText(character.name, x + 5, SCREEN_HEIGHT - 70);
                
                // Стоимость
                ctx.fillText(`${character.cost}⚡`, x + shopItemWidth / 2 - 15, SCREEN_HEIGHT - 50);
            }
        }

        // Обработка кликов по магазину
        function handleShopClick(x, y) {
            if (gameState.currentScreen !== 'game' || gameState.gameOver) return;
            
            const shopItemWidth = 120;
            const shopMargin = 20;
            const shopStartX = SCREEN_WIDTH / 2 - 300 + shopMargin;
            const shopY = SCREEN_HEIGHT - 130;
            const shopHeight = 100;
            
            for (let i = 0; i < gameState.ownedCharacters.length; i++) {
                const charId = gameState.ownedCharacters[i];
                const itemX = shopStartX + i * (shopItemWidth + shopMargin);
                
                if (x >= itemX && x <= itemX + shopItemWidth && 
                    y >= shopY && y <= shopY + shopHeight) {
                    spawnUnit(charId);
                    break;
                }
            }
        }

        // Игровой цикл
        function gameLoop() {
            updateGame();
            
            if (gameState.currentScreen === 'game') {
                renderGame();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Обработка кликов по canvas
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (gameState.currentScreen === 'game') {
                handleShopClick(x, y);
            }
        });

        // Запуск игры
        init();
    </script>
</body>
</html>
