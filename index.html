<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∏—Ç–≤–∞ –ö—Ä–µ–ø–æ—Å—Ç–µ–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', serif;
        }
        
        body {
            background: linear-gradient(135deg, #3e2723, #5d4037);
            color: #f5e8c8;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            position: relative;
            width: 1200px;
            height: 800px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            overflow: hidden;
            border: 8px solid #5d4037;
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(61, 43, 31, 0.95);
            z-index: 10;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect fill="%235d4037" width="100" height="100"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%233e2723" stroke-width="2"/></svg>');
        }
        
        .hidden {
            display: none;
        }
        
        h1 {
            font-size: 64px;
            color: #d7ccc8;
            margin-bottom: 20px;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.7);
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 3px solid #8d6e63;
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 48px;
            color: #d7ccc8;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            text-align: center;
            font-weight: bold;
        }
        
        p {
            font-size: 24px;
            margin-bottom: 40px;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
            color: #efebe9;
        }
        
        .button {
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            color: #fff;
            border: none;
            padding: 15px 30px;
            font-size: 22px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            min-width: 250px;
            text-align: center;
            border: 2px solid #5d4037;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .button:hover {
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        
        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .button:disabled {
            background: linear-gradient(to bottom, #795548, #5d4037);
            cursor: not-allowed;
            transform: none;
            color: #bcaaa4;
        }
        
        .stats-panel {
            background: rgba(93, 64, 55, 0.8);
            padding: 15px 30px;
            border-radius: 5px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            color: #efebe9;
        }
        
        .menu-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            width: 90%;
        }
        
        .card {
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            padding: 20px;
            width: 300px;
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-common { border-color: #a1887f; background: rgba(121, 85, 72, 0.8); }
        .card-rare { border-color: #4fc3f7; background: rgba(33, 150, 243, 0.2); }
        .card-epic { border-color: #ba68c8; background: rgba(156, 39, 176, 0.2); }
        .card-mythic { border-color: #ffb74d; background: rgba(255, 167, 38, 0.2); }
        .card-legendary { border-color: #ffd54f; background: rgba(255, 193, 7, 0.2); }
        
        .card-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .character-icon {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            overflow: hidden;
            border: 2px solid #5d4037;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .character-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .character-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #f5e8c8;
            text-align: center;
        }
        
        .character-rarity {
            font-size: 14px;
            opacity: 0.9;
            font-weight: bold;
        }
        
        .character-description {
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
            color: #efebe9;
            line-height: 1.4;
        }
        
        .character-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .stat-item {
            font-size: 14px;
            color: #f5e8c8;
        }
        
        .character-ability {
            font-size: 14px;
            color: #ffd54f;
            margin-bottom: 10px;
            text-align: center;
            font-style: italic;
        }
        
        .character-status {
            margin-top: auto;
            font-size: 16px;
            font-weight: bold;
        }
        
        .owned { color: #81c784; }
        .locked { color: #e57373; }
        
        .upgrade-panel {
            background: rgba(93, 64, 55, 0.8);
            border-radius: 5px;
            padding: 30px;
            width: 600px;
            margin-bottom: 30px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .upgrade-title {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            color: #f5e8c8;
            border-bottom: 1px solid #8d6e63;
            padding-bottom: 10px;
        }
        
        .upgrade-description {
            font-size: 16px;
            margin-bottom: 20px;
            color: #efebe9;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #5d4037;
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid #8d6e63;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8d6e63, #a1887f);
            border-radius: 5px;
        }
        
        .upgrade-stats {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            color: #f5e8c8;
        }
        
        .character-buttons {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(93, 64, 55, 0.8);
            border-top: 2px solid #8d6e63;
            z-index: 5;
        }
        
        .character-button {
            width: 80px;
            height: 80px;
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #5d4037;
            transition: all 0.3s;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .character-button:hover {
            transform: scale(1.05);
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
        }
        
        .character-button.disabled {
            background: linear-gradient(to bottom, #795548, #5d4037);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .character-button-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .character-button-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .character-button-name {
            font-size: 10px;
            text-align: center;
            color: #fff;
            font-weight: bold;
        }
        
        .character-button-cost {
            font-size: 10px;
            color: #ffd54f;
            font-weight: bold;
        }
        
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        
        .ui-panel {
            background: rgba(93, 64, 55, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: #f5e8c8;
        }
        
        .preparation-panel {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(93, 64, 55, 0.8);
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 24px;
            z-index: 5;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: #f5e8c8;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .programming-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 350px;
            height: 760px;
            background: rgba(93, 64, 55, 0.9);
            border-radius: 5px;
            padding: 20px;
            z-index: 10;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .programming-header {
            font-size: 24px;
            color: #f5e8c8;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #8d6e63;
            padding-bottom: 10px;
        }
        
        .programming-textarea {
            width: 100%;
            height: 500px;
            background: #5d4037;
            color: #f5e8c8;
            border: 1px solid #8d6e63;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            resize: none;
        }
        
        .programming-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .programming-button {
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .programming-button:hover {
            background: linear-gradient(to bottom, #a1887f, #8d6e63);
        }
        
        .programming-help {
            background: rgba(121, 85, 72, 0.8);
            border-radius: 5px;
            padding: 15px;
            font-size: 12px;
            color: #f5e8c8;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .programming-help h3 {
            margin-bottom: 10px;
            color: #ffd54f;
        }
        
        .programming-help ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .programming-help li {
            margin-bottom: 5px;
            padding-left: 10px;
            border-left: 2px solid #8d6e63;
        }
        
        .unit-program-button {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            z-index: 20;
            white-space: nowrap;
        }
        
        .game-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(61, 43, 31, 0.95);
            padding: 40px;
            border-radius: 5px;
            text-align: center;
            z-index: 20;
            border: 3px solid #8d6e63;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            width: 500px;
        }
        
        .case-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(61, 43, 31, 0.95);
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            z-index: 25;
            font-size: 20px;
            border: 2px solid #8d6e63;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            color: #f5e8c8;
        }
        
        .damage-popup {
            position: absolute;
            color: #ff5252;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            z-index: 15;
            text-shadow: 1px 1px 2px black;
            animation: floatUp 1s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
        
        .tooltip {
            position: absolute;
            background: rgba(61, 43, 31, 0.95);
            color: #f5e8c8;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            max-width: 200px;
            z-index: 100;
            pointer-events: none;
            border: 1px solid #8d6e63;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(61, 43, 31, 0.95);
            color: #f5e8c8;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            border: 2px solid #8d6e63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .energy-warning {
            color: #ff5252;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .selection-circle {
            position: absolute;
            border: 2px solid #4fc3f7;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
        }
        
        .vision-circle {
            position: absolute;
            border: 1px dashed rgba(79, 195, 247, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9;
        }
        
        .attack-circle {
            position: absolute;
            border: 1px dashed rgba(239, 83, 80, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9;
        }
        
        .movement-line {
            position: absolute;
            height: 2px;
            background: #4fc3f7;
            transform-origin: 0 0;
            pointer-events: none;
            z-index: 8;
        }
        
        /* –°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .medieval-border {
            border: 8px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z M10,10 L90,10 L90,90 L10,90 Z" fill="none" stroke="%238d6e63" stroke-width="4"/></svg>') 8 round;
        }
        
        .parchment {
            background: #f5e8c8;
            color: #5d4037;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #8d6e63;
        }
    </style>
</head>
<body>
    <div id="game-container" class="medieval-border">
        <canvas id="game-canvas" width="1200" height="800"></canvas>
        
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="main-menu" class="screen">
            <h1>‚öîÔ∏è –ë–∏—Ç–≤–∞ –ö—Ä–µ–ø–æ—Å—Ç–µ–π ‚öîÔ∏è</h1>
            <p class="parchment">–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è –±–∏—Ç–≤–∞ –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã –≤ —ç–ø–æ—Ö—É —Ä—ã—Ü–∞—Ä–µ–π –∏ –∑–∞–º–∫–æ–≤</p>
            
            <div class="stats-panel">
                <div class="stat">üí∞ <span id="gold-stat">1000</span></div>
                <div class="stat">‚ö° <span id="energy-stat">100</span></div>
                <div class="stat">üîë <span id="keys-stat">5</span></div>
                <div class="stat">üë• <span id="chars-stat">1/15</span></div>
            </div>
            
            <div class="menu-buttons">
                <button class="button" id="characters-btn">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
                <button class="button" id="play-btn">üéÆ –ò–≥—Ä–∞—Ç—å</button>
                <button class="button" id="production-btn">‚õèÔ∏è –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
                <button class="button" id="upgrades-btn">‚ö° –£–ª—É—á—à–µ–Ω–∏—è</button>
                <button class="button" id="cases-btn">üéÅ –ö–µ–π—Å—ã</button>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
        <div id="characters-screen" class="screen hidden">
            <h2>üë• –í–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
            <p class="parchment">–°–æ–±–∏—Ä–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤ –∏ —É–ª—É—á—à–∞–π—Ç–µ —Å–≤–æ—é –∞—Ä–º–∏—é</p>
            
            <button class="button" id="characters-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="card-grid" id="characters-container">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ -->
        <div id="production-screen" class="screen hidden">
            <h2>‚õèÔ∏è –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h2>
            <p class="parchment">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –º–æ—â–Ω–æ—Å—Ç—è–º–∏</p>
            
            <button class="button" id="production-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>üí∞ –ó–æ–ª–æ—Ç–∞—è —à–∞—Ö—Ç–∞</span>
                </div>
                <div class="upgrade-description">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç: <span id="mine-production">1</span> –∑–æ–ª–æ—Ç–∞/—Å–µ–∫</div>
                <div class="upgrade-stats">–£—Ä–æ–≤–µ–Ω—å: <span id="mine-level">1</span>/10</div>
                <button class="button" id="upgrade-mine-btn">–£–ª—É—á—à–∏—Ç—å —à–∞—Ö—Ç—É (<span id="mine-upgrade-cost">100</span>üí∞)</button>
            </div>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>üîë –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∫–ª—é—á–µ–π</span>
                </div>
                <div class="upgrade-description">–°—Ç–æ–∏–º–æ—Å—Ç—å –∫–ª—é—á–∞: 1000üí∞</div>
                <p class="parchment">–ö–ª—é—á–∏ –Ω—É–∂–Ω—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–æ–≤ —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</p>
                <div class="menu-buttons">
                    <button class="button" id="produce-1-key-btn">1 –∫–ª—é—á</button>
                    <button class="button" id="produce-10-keys-btn">10 –∫–ª—é—á–µ–π</button>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω —É–ª—É—á—à–µ–Ω–∏–π -->
        <div id="upgrades-screen" class="screen hidden">
            <h2>‚ö° –£–ª—É—á—à–µ–Ω–∏—è</h2>
            <p class="parchment">–£–ª—É—á—à–∞–π—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–≤–æ–µ–π –∫—Ä–µ–ø–æ—Å—Ç–∏ –∏ –∞—Ä–º–∏–∏</p>
            
            <button class="button" id="upgrades-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>‚ö° –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è</span>
                    <span id="energy-upgrade-cost">150</span>üí∞
                </div>
                <div class="upgrade-description">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ —é–Ω–∏—Ç–æ–≤</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="energy-progress" style="width: 10%"></div>
                </div>
                <div class="upgrade-stats">–£—Ä–æ–≤–µ–Ω—å: <span id="energy-level">1</span>/10 | –ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è: <span id="max-energy">100</span></div>
                <button class="button" id="upgrade-energy-btn">–£–ª—É—á—à–∏—Ç—å</button>
            </div>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>‚ù§Ô∏è –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∑–∞–º–∫–∞</span>
                    <span id="castle-upgrade-cost">200</span>üí∞
                </div>
                <div class="upgrade-description">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø—Ä–æ—á–Ω–æ—Å—Ç—å –≤–∞—à–µ–π –∫—Ä–µ–ø–æ—Å—Ç–∏</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="castle-progress" style="width: 10%"></div>
                </div>
                <div class="upgrade-stats">–£—Ä–æ–≤–µ–Ω—å: <span id="castle-level">1</span>/10 | –ó–¥–æ—Ä–æ–≤—å–µ: <span id="castle-health">1000</span></div>
                <button class="button" id="upgrade-castle-btn">–£–∫—Ä–µ–ø–∏—Ç—å –∑–∞–º–æ–∫</button>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –∫–µ–π—Å–æ–≤ -->
        <div id="cases-screen" class="screen hidden">
            <h2>üéÅ –ö–µ–π—Å—ã</h2>
            <p class="parchment">–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–µ–π—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –±–æ–Ω—É—Å–æ–≤</p>
            
            <button class="button" id="cases-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="upgrade-panel">
                <div class="upgrade-title">
                    <span>üéÅ –ë–æ–µ–≤–æ–π –∫–µ–π—Å</span>
                </div>
                <div class="upgrade-stats">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏: <span id="available-keys">5</span> üîë</div>
                <p class="parchment">–®–∞–Ω—Å—ã: –ó–æ–ª–æ—Ç–æ 75%, –û–±—ã—á–Ω—ã–π 15%, –†–µ–¥–∫–∏–π 6%, –≠–ø–∏—á–µ—Å–∫–∏–π 3%, –ú–∏—Ñ–∏—á–µ—Å–∫–∏–π 0.9%, –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π 0.1%</p>
                <button class="button" id="open-case-btn">–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å (1üîë)</button>
            </div>
        </div>
        
        <!-- –ò–≥—Ä–æ–≤–æ–π UI (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞) -->
        <div id="game-ui" class="game-ui hidden">
            <div class="ui-panel" id="energy-panel">
                ‚ö° <span id="game-energy">100</span>/<span id="game-max-energy">100</span>
            </div>
            <div class="ui-panel">
                ‚ù§Ô∏è <span id="game-health">1000</span>
            </div>
            <div class="ui-panel">
                ‚è±Ô∏è <span id="game-timer">60</span>—Å
            </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ -->
        <div id="preparation-panel" class="preparation-panel hidden">
            <div>–§–∞–∑–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</div>
            <div id="preparation-timer">60</div>
            <button class="button" id="start-early-btn">–ù–∞—á–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ</button>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
        <div id="character-buttons" class="character-buttons hidden">
            <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div id="programming-panel" class="programming-panel hidden">
            <div class="programming-header">–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —é–Ω–∏—Ç–∞</div>
            <textarea id="programming-textarea" class="programming-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —é–Ω–∏—Ç–∞..."></textarea>
            <div class="programming-buttons">
                <button class="programming-button" id="apply-program-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —é–Ω–∏—Ç—É</button>
                <button class="programming-button" id="apply-all-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —é–Ω–∏—Ç–∞–º</button>
                <button class="programming-button" id="apply-type-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —ç—Ç–æ–≥–æ —Ç–∏–ø–∞</button>
                <button class="programming-button" id="close-programming-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div class="programming-help">
                <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</h3>
                <ul>
                    <li>move_forward(distance) - –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä–µ–¥</li>
                    <li>move_backward(distance) - –¥–≤–∏–≥–∞—Ç—å—Å—è –Ω–∞–∑–∞–¥</li>
                    <li>move_left(distance) - –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ª–µ–≤–æ</li>
                    <li>move_right(distance) - –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø—Ä–∞–≤–æ</li>
                    <li>attack() - –∞—Ç–∞–∫–æ–≤–∞—Ç—å (–≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏)</li>
                    <li>move_to(x, y) - –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º</li>
                    <li>get_enemy_coords() - –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä–∞–≥–∞</li>
                </ul>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã -->
        <div id="game-result" class="game-result hidden">
            <h2 id="result-title">–ü–û–ë–ï–î–ê!</h2>
            <p id="result-message">+1 –∫–ª—é—á, +50 –∑–æ–ª–æ—Ç–∞</p>
            <button class="button" id="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞ -->
        <div id="case-result" class="case-result hidden">
            <p id="case-result-message">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!</p>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã
        const SCREEN_WIDTH = 1200;
        const SCREEN_HEIGHT = 800;
        const FPS = 60;
        const PREPARATION_TIME = 60; // 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É
        const BATTLE_DURATION = 120; // 120 —Å–µ–∫—É–Ω–¥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∏—Ç–≤—ã

        // –¶–≤–µ—Ç–∞ –≤ —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–æ–º —Å—Ç–∏–ª–µ
        const COLORS = {
            BACKGROUND: '#5d4037',
            GOLD: '#ffd54f',
            ENERGY: '#4fc3f7',
            HEALTH: '#ef5350',
            TEXT: '#f5e8c8',
            BUTTON: '#8d6e63',
            BUTTON_HOVER: '#a1887f',
            PANEL: 'rgba(93, 64, 55, 0.8)',
            CASTLE: '#6d4c41',
            BATTLEFIELD: '#7cb342',
            RARITY: {
                common: '#a1887f',
                rare: '#4fc3f7',
                epic: '#ba68c8',
                mythic: '#ffb74d',
                legendary: '#ffd54f'
            }
        };

        // –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const characters = {
            'white_guy': {
                'name': '–ë–µ–ª—ã–π –í–æ–∏–Ω',
                'image': 'white_guy.png',
                'cost': 10,
                'health': 100,
                'damage': 20,
                'speed': 1.5,
                'attack_speed': 1.0,
                'attack_range': 80,
                'vision_range': 150,
                'description': '–ë–∞–∑–æ–≤—ã–π –±–æ–µ—Ü, —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏',
                'rarity': 'common',
                'ability': null,
                'owned': true
            },
            'yellow_guy': {
                'name': '–ñ–µ–ª—Ç—ã–π –°—Ç—Ä–∞–∂',
                'image': 'yellow_guy.png',
                'cost': 15,
                'health': 80,
                'damage': 25,
                'speed': 2.0,
                'attack_speed': 1.2,
                'attack_range': 70,
                'vision_range': 140,
                'description': '–ë—ã—Å—Ç—Ä—ã–π –∞—Ç–∞–∫—É—é—â–∏–π',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'red_guy': {
                'name': '–ö—Ä–∞—Å–Ω—ã–π –ë–µ—Ä—Å–µ—Ä–∫',
                'image': 'red_guy.png',
                'cost': 20,
                'health': 120,
                'damage': 30,
                'speed': 1.0,
                'attack_speed': 0.8,
                'attack_range': 60,
                'vision_range': 130,
                'description': '–ú–æ—â–Ω—ã–π —É–¥–∞—Ä, –º–µ–¥–ª–µ–Ω–Ω—ã–π',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'green_guy': {
                'name': '–ó–µ–ª–µ–Ω—ã–π –õ—É—á–Ω–∏–∫',
                'image': 'green_guy.png',
                'cost': 25,
                'health': 70,
                'damage': 35,
                'speed': 1.7,
                'attack_speed': 1.5,
                'attack_range': 120,
                'vision_range': 200,
                'description': '–î–∞–ª—å–Ω–∏–π –±–æ–π, –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å',
                'rarity': 'common',
                'ability': null,
                'owned': false
            },
            'blue_guy': {
                'name': '–°–∏–Ω–∏–π –ú–∞–≥',
                'image': 'blue_guy.png',
                'cost': 30,
                'health': 60,
                'damage': 40,
                'speed': 1.2,
                'attack_speed': 0.7,
                'attack_range': 150,
                'vision_range': 180,
                'description': '–ú–æ—â–Ω—ã–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è',
                'rarity': 'common',
                'ability': null,
                'owned': false
            }
        };

        const enemyTypes = [
            {health: 80, damage: 15, speed: 1.0, attack_speed: 1.0, attack_range: 70, vision_range: 120, image: 'white_guy.png'},
            {health: 50, damage: 25, speed: 1.5, attack_speed: 1.2, attack_range: 90, vision_range: 130, image: 'yellow_guy.png'},
            {health: 120, damage: 10, speed: 0.8, attack_speed: 0.8, attack_range: 60, vision_range: 110, image: 'red_guy.png'}
        ];

        // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let gameState = {
            currentScreen: 'main_menu',
            gamePhase: 'preparation', // preparation, battle, result
            gold: 1000,
            energy: 100,
            maxEnergy: 100,
            playerHealth: 1000,
            maxCastleHealth: 1000,
            mineLevel: 1,
            mineProduction: 1,
            mineUpgradeCost: 100,
            energyGenLevel: 1,
            energyGenUpgradeCost: 150,
            castleLevel: 1,
            castleUpgradeCost: 200,
            keys: 5,
            ownedCharacters: ['white_guy'],
            units: [],
            enemyUnits: [],
            enemySpawnTimer: 0,
            unitCounter: 0,
            enemyCounter: 0,
            lastGoldUpdate: 0,
            lastSecondUpdate: 0,
            preparationTimeLeft: PREPARATION_TIME,
            battleTimeLeft: BATTLE_DURATION,
            gameOver: false,
            gameResult: null,
            damagePopups: [],
            selectedCharacter: null,
            selectedUnit: null,
            gamesPlayed: 0,
            gamesWon: 0
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        const screens = {
            main_menu: document.getElementById('main-menu'),
            characters: document.getElementById('characters-screen'),
            game: null, // –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω —Ä–∏—Å—É–µ—Ç—Å—è –Ω–∞ canvas
            production: document.getElementById('production-screen'),
            upgrades: document.getElementById('upgrades-screen'),
            cases: document.getElementById('cases-screen')
        };

        // –ö–Ω–æ–ø–∫–∏
        const buttons = {
            // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            characters: document.getElementById('characters-btn'),
            play: document.getElementById('play-btn'),
            production: document.getElementById('production-btn'),
            upgrades: document.getElementById('upgrades-btn'),
            cases: document.getElementById('cases-btn'),
            
            // –ù–∞–∑–∞–¥
            charactersBack: document.getElementById('characters-back-btn'),
            productionBack: document.getElementById('production-back-btn'),
            upgradesBack: document.getElementById('upgrades-back-btn'),
            casesBack: document.getElementById('cases-back-btn'),
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
            upgradeMine: document.getElementById('upgrade-mine-btn'),
            produce1Key: document.getElementById('produce-1-key-btn'),
            produce10Keys: document.getElementById('produce-10-keys-btn'),
            
            // –£–ª—É—á—à–µ–Ω–∏—è
            upgradeEnergy: document.getElementById('upgrade-energy-btn'),
            upgradeCastle: document.getElementById('upgrade-castle-btn'),
            
            // –ö–µ–π—Å—ã
            openCase: document.getElementById('open-case-btn'),
            
            // –ò–≥—Ä–∞
            continue: document.getElementById('continue-btn'),
            startEarly: document.getElementById('start-early-btn'),
            
            // –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            applyProgram: document.getElementById('apply-program-btn'),
            applyAll: document.getElementById('apply-all-btn'),
            applyType: document.getElementById('apply-type-btn'),
            closeProgramming: document.getElementById('close-programming-btn')
        };

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const stats = {
            gold: document.getElementById('gold-stat'),
            energy: document.getElementById('energy-stat'),
            keys: document.getElementById('keys-stat'),
            chars: document.getElementById('chars-stat'),
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
            mineProduction: document.getElementById('mine-production'),
            mineLevel: document.getElementById('mine-level'),
            mineUpgradeCost: document.getElementById('mine-upgrade-cost'),
            
            // –£–ª—É—á—à–µ–Ω–∏—è
            energyLevel: document.getElementById('energy-level'),
            maxEnergy: document.getElementById('max-energy'),
            energyUpgradeCost: document.getElementById('energy-upgrade-cost'),
            energyProgress: document.getElementById('energy-progress'),
            castleLevel: document.getElementById('castle-level'),
            castleHealth: document.getElementById('castle-health'),
            castleUpgradeCost: document.getElementById('castle-upgrade-cost'),
            castleProgress: document.getElementById('castle-progress'),
            
            // –ö–µ–π—Å—ã
            availableKeys: document.getElementById('available-keys'),
            
            // –ò–≥—Ä–∞
            gameEnergy: document.getElementById('game-energy'),
            gameMaxEnergy: document.getElementById('game-max-energy'),
            gameHealth: document.getElementById('game-health'),
            gameTimer: document.getElementById('game-timer')
        };

        // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const gameResult = document.getElementById('game-result');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const caseResult = document.getElementById('case-result');
        const caseResultMessage = document.getElementById('case-result-message');

        // –ò–≥—Ä–æ–≤–æ–π UI
        const gameUI = document.getElementById('game-ui');
        const preparationPanel = document.getElementById('preparation-panel');
        const preparationTimer = document.getElementById('preparation-timer');
        const energyPanel = document.getElementById('energy-panel');
        const characterButtons = document.getElementById('character-buttons');
        const programmingPanel = document.getElementById('programming-panel');
        const programmingTextarea = document.getElementById('programming-textarea');

        // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const images = {};

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function distance(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function init() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            loadImages().then(() => {
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
                setupButtons();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                updateStats();
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                createCharacterButtons();
                
                // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
                gameLoop();
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function loadImages() {
            const promises = [];
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            Object.values(characters).forEach(character => {
                promises.push(loadImage(character.image));
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Ä–∞–≥–æ–≤
            enemyTypes.forEach(enemy => {
                promises.push(loadImage(enemy.image));
            });
            
            return Promise.all(promises);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    images[src] = img;
                    resolve();
                };
                img.onerror = () => {
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    const canvas = document.createElement('canvas');
                    canvas.width = 60;
                    canvas.height = 60;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(0, 0, 60, 60);
                    ctx.fillStyle = '#5d4037';
                    ctx.font = '10px Arial';
                    ctx.fillText('IMG', 20, 30);
                    images[src] = canvas;
                    resolve();
                };
                img.src = src;
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫
        function setupButtons() {
            // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            buttons.characters.addEventListener('click', () => showScreen('characters'));
            buttons.play.addEventListener('click', startGame);
            buttons.production.addEventListener('click', () => showScreen('production'));
            buttons.upgrades.addEventListener('click', () => showScreen('upgrades'));
            buttons.cases.addEventListener('click', () => showScreen('cases'));
            
            // –ù–∞–∑–∞–¥
            buttons.charactersBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.productionBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.upgradesBack.addEventListener('click', () => showScreen('main_menu'));
            buttons.casesBack.addEventListener('click', () => {
                showScreen('main_menu');
                hideCaseResult();
            });
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
            buttons.upgradeMine.addEventListener('click', upgradeMine);
            buttons.produce1Key.addEventListener('click', () => produceKeys(1));
            buttons.produce10Keys.addEventListener('click', () => produceKeys(10));
            
            // –£–ª—É—á—à–µ–Ω–∏—è
            buttons.upgradeEnergy.addEventListener('click', upgradeEnergy);
            buttons.upgradeCastle.addEventListener('click', upgradeCastle);
            
            // –ö–µ–π—Å—ã
            buttons.openCase.addEventListener('click', openCase);
            
            // –ò–≥—Ä–∞
            buttons.continue.addEventListener('click', () => {
                gameResult.classList.add('hidden');
                showScreen('main_menu');
            });
            
            // –ù–∞—á–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ
            buttons.startEarly.addEventListener('click', startBattle);
            
            // –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            buttons.applyProgram.addEventListener('click', applyProgram);
            buttons.applyAll.addEventListener('click', applyProgramToAll);
            buttons.applyType.addEventListener('click', applyProgramToType);
            buttons.closeProgramming.addEventListener('click', closeProgrammingPanel);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        function createCharacterButtons() {
            characterButtons.innerHTML = '';
            
            gameState.ownedCharacters.forEach(charId => {
                const character = characters[charId];
                const button = document.createElement('div');
                button.className = 'character-button';
                button.dataset.characterId = charId;
                
                button.innerHTML = `
                    <div class="character-button-icon">
                        <img src="${character.image}" alt="${character.name}">
                    </div>
                    <div class="character-button-name">${character.name}</div>
                    <div class="character-button-cost">${character.cost}‚ö°</div>
                `;
                
                button.addEventListener('click', () => {
                    gameState.selectedCharacter = charId;
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —é–Ω–∏—Ç–æ–≤
                    gameState.selectedUnit = null;
                });
                
                characterButtons.appendChild(button);
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            Object.values(screens).forEach(screen => {
                if (screen) screen.classList.add('hidden');
            });
            
            // –°–∫—Ä—ã—Ç—å –∏–≥—Ä–æ–≤–æ–π UI
            gameUI.classList.add('hidden');
            preparationPanel.classList.add('hidden');
            characterButtons.classList.add('hidden');
            programmingPanel.classList.add('hidden');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
            if (screenName === 'game') {
                // –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω —Ä–∏—Å—É–µ—Ç—Å—è –Ω–∞ canvas
                gameUI.classList.remove('hidden');
                characterButtons.classList.remove('hidden');
                
                if (gameState.gamePhase === 'preparation') {
                    preparationPanel.classList.remove('hidden');
                }
            } else if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
            
            gameState.currentScreen = screenName;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —ç–∫—Ä–∞–Ω–∞
            if (screenName === 'characters') {
                renderCharactersScreen();
            } else if (screenName === 'production' || screenName === 'upgrades' || 
                      screenName === 'cases' || screenName === 'main_menu') {
                updateStats();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            stats.gold.textContent = gameState.gold;
            stats.energy.textContent = gameState.energy;
            stats.keys.textContent = gameState.keys;
            stats.chars.textContent = `${gameState.ownedCharacters.length}/${Object.keys(characters).length}`;
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
            stats.mineProduction.textContent = gameState.mineProduction;
            stats.mineLevel.textContent = gameState.mineLevel;
            stats.mineUpgradeCost.textContent = gameState.mineUpgradeCost;
            
            // –£–ª—É—á—à–µ–Ω–∏—è
            stats.energyLevel.textContent = gameState.energyGenLevel;
            stats.maxEnergy.textContent = gameState.maxEnergy;
            stats.energyUpgradeCost.textContent = gameState.energyGenUpgradeCost;
            stats.energyProgress.style.width = `${(gameState.energyGenLevel / 10) * 100}%`;
            
            stats.castleLevel.textContent = gameState.castleLevel;
            stats.castleHealth.textContent = gameState.maxCastleHealth;
            stats.castleUpgradeCost.textContent = gameState.castleUpgradeCost;
            stats.castleProgress.style.width = `${(gameState.castleLevel / 10) * 100}%`;
            
            // –ö–µ–π—Å—ã
            stats.availableKeys.textContent = gameState.keys;
            
            // –ò–≥—Ä–∞
            stats.gameEnergy.textContent = gameState.energy;
            stats.gameMaxEnergy.textContent = gameState.maxEnergy;
            stats.gameHealth.textContent = gameState.playerHealth;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã –∏–≥—Ä—ã
            if (gameState.gamePhase === 'preparation') {
                stats.gameTimer.textContent = Math.ceil(gameState.preparationTimeLeft);
                preparationTimer.textContent = Math.ceil(gameState.preparationTimeLeft);
            } else if (gameState.gamePhase === 'battle') {
                stats.gameTimer.textContent = Math.ceil(gameState.battleTimeLeft);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π
            updateUpgradeButtons();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π
        function updateUpgradeButtons() {
            // –®–∞—Ö—Ç–∞
            buttons.upgradeMine.disabled = gameState.gold < gameState.mineUpgradeCost || gameState.mineLevel >= 10;
            if (gameState.mineLevel >= 10) {
                buttons.upgradeMine.textContent = "–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å";
            } else {
                buttons.upgradeMine.textContent = `–£–ª—É—á—à–∏—Ç—å —à–∞—Ö—Ç—É (${gameState.mineUpgradeCost}üí∞)`;
            }
            
            // –≠–Ω–µ—Ä–≥–∏—è
            buttons.upgradeEnergy.disabled = gameState.gold < gameState.energyGenUpgradeCost || gameState.energyGenLevel >= 10;
            if (gameState.energyGenLevel >= 10) {
                buttons.upgradeEnergy.textContent = "–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å";
            } else {
                buttons.upgradeEnergy.textContent = "–£–ª—É—á—à–∏—Ç—å";
            }
            
            // –ó–∞–º–æ–∫
            buttons.upgradeCastle.disabled = gameState.gold < gameState.castleUpgradeCost || gameState.castleLevel >= 10;
            if (gameState.castleLevel >= 10) {
                buttons.upgradeCastle.textContent = "–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å";
            } else {
                buttons.upgradeCastle.textContent = "–£–∫—Ä–µ–ø–∏—Ç—å –∑–∞–º–æ–∫";
            }
            
            // –ö–µ–π—Å—ã
            buttons.openCase.disabled = gameState.keys <= 0;
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∫–ª—é—á–µ–π
            buttons.produce1Key.disabled = gameState.gold < 1000;
            buttons.produce10Keys.disabled = gameState.gold < 10000;
        }

        // –†–µ–Ω–¥–µ—Ä —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        function renderCharactersScreen() {
            const container = document.getElementById('characters-container');
            container.innerHTML = '';
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
            const sortedChars = Object.entries(characters).sort((a, b) => {
                const rarityOrder = ['common', 'rare', 'epic', 'mythic', 'legendary'];
                return rarityOrder.indexOf(b[1].rarity) - rarityOrder.indexOf(a[1].rarity);
            });
            
            sortedChars.forEach(([charId, char]) => {
                const card = document.createElement('div');
                card.className = `card card-${char.rarity}`;
                
                const isOwned = gameState.ownedCharacters.includes(charId);
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="character-icon">
                            <img src="${char.image}" alt="${char.name}">
                        </div>
                        <div class="character-name">${char.name}</div>
                        <div class="character-rarity">${char.rarity.toUpperCase()}</div>
                    </div>
                    <div class="character-description">${char.description}</div>
                    ${char.ability ? `<div class="character-ability">${char.ability}</div>` : ''}
                    <div class="character-stats">
                        <div class="stat-item">‚ù§Ô∏è ${char.health}</div>
                        <div class="stat-item">‚öîÔ∏è ${char.damage}</div>
                        <div class="stat-item">üëü ${char.speed}</div>
                        <div class="stat-item">üìè ${char.attack_range}</div>
                        <div class="stat-item">üëÅÔ∏è ${char.vision_range}</div>
                        <div class="stat-item">‚ö° ${char.cost}</div>
                    </div>
                    <div class="character-status ${isOwned ? 'owned' : 'locked'}">
                        ${isOwned ? '‚úÖ –í –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏' : 'üîí –ù–µ –ø–æ–ª—É—á–µ–Ω'}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
        function startGame() {
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
            gameState.playerHealth = gameState.maxCastleHealth;
            gameState.energy = gameState.maxEnergy;
            gameState.units = [];
            gameState.enemyUnits = [];
            gameState.enemySpawnTimer = 0;
            gameState.unitCounter = 0;
            gameState.enemyCounter = 0;
            gameState.preparationTimeLeft = PREPARATION_TIME;
            gameState.battleTimeLeft = BATTLE_DURATION;
            gameState.gamePhase = 'preparation';
            gameState.gameOver = false;
            gameState.gameResult = null;
            gameState.damagePopups = [];
            gameState.selectedCharacter = null;
            gameState.selectedUnit = null;
            gameState.lastSecondUpdate = Date.now();
            
            showScreen('game');
        }

        // –ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É (–∑–∞–≤–µ—Ä—à–∏—Ç—å —Ñ–∞–∑—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏)
        function startBattle() {
            gameState.gamePhase = 'battle';
            preparationPanel.classList.add('hidden');
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ —é–Ω–∏—Ç–∞
        function placeUnit(x, y) {
            if (gameState.selectedCharacter && gameState.energy >= characters[gameState.selectedCharacter].cost) {
                const character = characters[gameState.selectedCharacter];
                
                gameState.energy -= character.cost;
                gameState.unitCounter++;
                gameState.units.push({
                    id: `unit_${gameState.unitCounter}`,
                    characterId: gameState.selectedCharacter,
                    x: x,
                    y: y,
                    health: character.health,
                    maxHealth: character.health,
                    damage: character.damage,
                    speed: character.speed,
                    attackSpeed: character.attack_speed,
                    attackRange: character.attack_range,
                    visionRange: character.vision_range,
                    image: character.image,
                    program: [], // –ü—Ä–æ–≥—Ä–∞–º–º–∞ —é–Ω–∏—Ç–∞
                    state: 'idle', // idle, moving, attacking
                    target: null,
                    moveTarget: null,
                    lastAttackTime: 0,
                    isExecuting: false // –í—ã–ø–æ–ª–Ω—è–µ—Ç –ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É
                });
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                createDamagePopup(x, y, `-${character.cost}‚ö°`, '#4fc3f7');
                updateStats();
                
                return true;
            } else {
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —ç–Ω–µ—Ä–≥–∏–∏
                if (gameState.energy < characters[gameState.selectedCharacter].cost) {
                    energyPanel.classList.add('energy-warning');
                    setTimeout(() => {
                        energyPanel.classList.remove('energy-warning');
                    }, 1000);
                    
                    createDamagePopup(x, y, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!", '#ef5350');
                }
                return false;
            }
        }

        // –í—ã–±–æ—Ä —é–Ω–∏—Ç–∞
        function selectUnit(x, y) {
            // –ò—â–µ–º —é–Ω–∏—Ç–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            for (let i = gameState.units.length - 1; i >= 0; i--) {
                const unit = gameState.units[i];
                if (distance(x, y, unit.x, unit.y) < 30) {
                    gameState.selectedUnit = unit;
                    gameState.selectedCharacter = null;
                    return true;
                }
            }
            return false;
        }

        // –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
        function openProgrammingPanel() {
            if (gameState.selectedUnit) {
                programmingTextarea.value = gameState.selectedUnit.program.join('\n');
                programmingPanel.classList.remove('hidden');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
        function closeProgrammingPanel() {
            programmingPanel.classList.add('hidden');
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —é–Ω–∏—Ç—É
        function applyProgram() {
            if (gameState.selectedUnit) {
                const programText = programmingTextarea.value;
                const programLines = programText.split('\n').filter(line => line.trim() !== '');
                gameState.selectedUnit.program = programLines;
                gameState.selectedUnit.isExecuting = true;
                showNotification('–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —é–Ω–∏—Ç—É!');
            }
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–æ –≤—Å–µ–º —é–Ω–∏—Ç–∞–º
        function applyProgramToAll() {
            const programText = programmingTextarea.value;
            const programLines = programText.split('\n').filter(line => line.trim() !== '');
            
            gameState.units.forEach(unit => {
                unit.program = [...programLines];
                unit.isExecuting = true;
            });
            
            showNotification('–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ –≤—Å–µ–º —é–Ω–∏—Ç–∞–º!');
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–æ –≤—Å–µ–º —é–Ω–∏—Ç–∞–º —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
        function applyProgramToType() {
            if (gameState.selectedUnit) {
                const programText = programmingTextarea.value;
                const programLines = programText.split('\n').filter(line => line.trim() !== '');
                const characterId = gameState.selectedUnit.characterId;
                
                gameState.units.forEach(unit => {
                    if (unit.characterId === characterId) {
                        unit.program = [...programLines];
                        unit.isExecuting = true;
                    }
                });
                
                showNotification(`–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ –≤—Å–µ–º —é–Ω–∏—Ç–∞–º —Ç–∏–ø–∞ ${characters[characterId].name}!`);
            }
        }

        // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã —é–Ω–∏—Ç–∞
        function executeUnitProgram(unit) {
            if (!unit.isExecuting || unit.program.length === 0) return;
            
            const character = characters[unit.characterId];
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –∑–∞ –∫–∞–¥—Ä
            for (let i = 0; i < unit.program.length; i++) {
                const command = unit.program[i].trim();
                
                // –ü–∞—Ä—Å–∏–º –∫–æ–º–∞–Ω–¥—É
                if (command.startsWith('move_forward(')) {
                    const distance = parseFloat(command.match(/move_forward\((\d+)\)/)[1]);
                    unit.y = Math.max(30, unit.y - distance);
                    break;
                }
                else if (command.startsWith('move_backward(')) {
                    const distance = parseFloat(command.match(/move_backward\((\d+)\)/)[1]);
                    unit.y = Math.min(SCREEN_HEIGHT - 30, unit.y + distance);
                    break;
                }
                else if (command.startsWith('move_left(')) {
                    const distance = parseFloat(command.match(/move_left\((\d+)\)/)[1]);
                    unit.x = Math.max(30, unit.x - distance);
                    break;
                }
                else if (command.startsWith('move_right(')) {
                    const distance = parseFloat(command.match(/move_right\((\d+)\)/)[1]);
                    unit.x = Math.min(SCREEN_WIDTH - 30, unit.x + distance);
                    break;
                }
                else if (command === 'attack()') {
                    // –ü–æ–∏—Å–∫ –≤—Ä–∞–≥–∞ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏
                    let enemyInRange = null;
                    for (const enemy of gameState.enemyUnits) {
                        if (distance(unit.x, unit.y, enemy.x, enemy.y) <= unit.attackRange) {
                            enemyInRange = enemy;
                            break;
                        }
                    }
                    
                    if (enemyInRange) {
                        enemyInRange.health -= unit.damage;
                        createDamagePopup(enemyInRange.x, enemyInRange.y, `-${unit.damage}`, '#ef5350');
                        
                        if (enemyInRange.health <= 0) {
                            gameState.enemyUnits = gameState.enemyUnits.filter(u => u !== enemyInRange);
                        }
                    }
                    break;
                }
                else if (command.startsWith('move_to(')) {
                    const match = command.match(/move_to\((\d+),\s*(\d+)\)/);
                    if (match) {
                        const x = parseInt(match[1]);
                        const y = parseInt(match[2]);
                        
                        // –ü—Ä–æ—Å—Ç–æ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º —é–Ω–∏—Ç–∞ –∫ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                        unit.x = Math.max(30, Math.min(SCREEN_WIDTH - 30, x));
                        unit.y = Math.max(30, Math.min(SCREEN_HEIGHT - 30, y));
                    }
                    break;
                }
                else if (command === 'get_enemy_coords()') {
                    // –ü–æ–∏—Å–∫ –≤—Ä–∞–≥–∞ –≤ –ø–æ–ª–µ –∑—Ä–µ–Ω–∏—è
                    let closestEnemy = null;
                    let closestDistance = unit.visionRange;
                    
                    for (const enemy of gameState.enemyUnits) {
                        const dist = distance(unit.x, unit.y, enemy.x, enemy.y);
                        if (dist < closestDistance) {
                            closestDistance = dist;
                            closestEnemy = enemy;
                        }
                    }
                    
                    if (closestEnemy) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä–∞–≥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ
                        unit.program.push(`# enemy_coords: ${closestEnemy.x}, ${closestEnemy.y}`);
                    }
                    break;
                }
            }
        }

        // –°–ø–∞–≤–Ω –≤—Ä–∞–∂–µ—Å–∫–æ–≥–æ —é–Ω–∏—Ç–∞
        function spawnEnemyUnit() {
            const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            // –°–ø–∞–≤–Ω —Å –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞
            let x, y;
            const side = Math.floor(Math.random() * 4); // 0: –≤–µ—Ä—Ö, 1: –ø—Ä–∞–≤–æ, 2: –Ω–∏–∑, 3: –ª–µ–≤–æ
            
            switch (side) {
                case 0: // –í–µ—Ä—Ö
                    x = Math.random() * SCREEN_WIDTH;
                    y = -30;
                    break;
                case 1: // –ü—Ä–∞–≤–æ
                    x = SCREEN_WIDTH + 30;
                    y = Math.random() * SCREEN_HEIGHT;
                    break;
                case 2: // –ù–∏–∑
                    x = Math.random() * SCREEN_WIDTH;
                    y = SCREEN_HEIGHT + 30;
                    break;
                case 3: // –õ–µ–≤–æ
                    x = -30;
                    y = Math.random() * SCREEN_HEIGHT;
                    break;
            }
            
            gameState.enemyCounter++;
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–∞–≥–∞ —Å —Ü–µ–ª—å—é - –∑–∞–º–∫–æ–º
            const enemy = {
                id: `enemy_${gameState.enemyCounter}`,
                x: x,
                y: y,
                health: enemyType.health,
                maxHealth: enemyType.health,
                damage: enemyType.damage,
                speed: enemyType.speed,
                attackSpeed: enemyType.attack_speed,
                attackRange: enemyType.attack_range,
                visionRange: enemyType.vision_range,
                image: enemyType.image,
                target: {x: SCREEN_WIDTH / 2, y: SCREEN_HEIGHT / 2, isCastle: true}, // –¶–µ–ª—å - –∑–∞–º–æ–∫
                lastAttackTime: 0,
                state: 'moving' // moving, attacking
            };
            
            gameState.enemyUnits.push(enemy);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Ä–æ–Ω–µ
        function createDamagePopup(x, y, text, color) {
            gameState.damagePopups.push({
                x: x,
                y: y,
                text: text,
                color: color,
                life: 1000,
                createdAt: Date.now()
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —é–Ω–∏—Ç–æ–≤
        function updateUnits() {
            const now = Date.now();
            const castleX = SCREEN_WIDTH / 2;
            const castleY = SCREEN_HEIGHT / 2;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —é–Ω–∏—Ç–æ–≤ –∏–≥—Ä–æ–∫–∞
            gameState.units.forEach(unit => {
                // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —é–Ω–∏—Ç–∞
                if (unit.isExecuting && unit.program.length > 0) {
                    executeUnitProgram(unit);
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ - —é–Ω–∏—Ç—ã –¥–≤–∏–≥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–∂–µ—Å–∫–∏—Ö —é–Ω–∏—Ç–æ–≤
            gameState.enemyUnits.forEach(enemy => {
                // –ü–æ–∏—Å–∫ —Ü–µ–ª–∏ (—é–Ω–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞ –∏–ª–∏ –∫—Ä–µ–ø–æ—Å—Ç—å)
                if (!enemy.target) {
                    let closestTarget = null;
                    let closestDistance = enemy.visionRange;
                    
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–µ–≥–æ —é–Ω–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞
                    gameState.units.forEach(unit => {
                        const dist = distance(enemy.x, enemy.y, unit.x, unit.y);
                        if (dist < closestDistance) {
                            closestDistance = dist;
                            closestTarget = unit;
                        }
                    });
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —é–Ω–∏—Ç–∞, —Ü–µ–ª—å - –∫—Ä–µ–ø–æ—Å—Ç—å
                    if (!closestTarget) {
                        const distToCastle = distance(enemy.x, enemy.y, castleX, castleY);
                        if (distToCastle < enemy.visionRange) {
                            closestTarget = {x: castleX, y: castleY, isCastle: true};
                            closestDistance = distToCastle;
                        }
                    }
                    
                    if (closestTarget) {
                        enemy.target = closestTarget;
                    }
                }
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                if (enemy.target && enemy.state === 'moving') {
                    const dx = enemy.target.x - enemy.x;
                    const dy = enemy.target.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist > enemy.attackRange) {
                        // –î–≤–∏–≥–∞–µ–º—Å—è –∫ —Ü–µ–ª–∏
                        enemy.x += (dx / dist) * enemy.speed;
                        enemy.y += (dy / dist) * enemy.speed;
                    } else {
                        // –ê—Ç–∞–∫—É–µ–º —Ü–µ–ª—å, –µ—Å–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏
                        enemy.state = 'attacking';
                    }
                }
                
                // –ê—Ç–∞–∫–∞
                if (enemy.target && enemy.state === 'attacking') {
                    const dist = distance(enemy.x, enemy.y, enemy.target.x, enemy.target.y);
                    
                    if (dist <= enemy.attackRange) {
                        if (!enemy.lastAttackTime || now - enemy.lastAttackTime > (1000 / enemy.attackSpeed)) {
                            if (enemy.target.isCastle) {
                                // –ê—Ç–∞–∫–∞ –∫—Ä–µ–ø–æ—Å—Ç–∏
                                gameState.playerHealth -= enemy.damage;
                                createDamagePopup(castleX, castleY, `-${enemy.damage}`, '#ef5350');
                            } else {
                                // –ê—Ç–∞–∫–∞ —é–Ω–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞
                                enemy.target.health -= enemy.damage;
                                createDamagePopup(enemy.target.x, enemy.target.y, `-${enemy.damage}`, '#ef5350');
                                
                                if (enemy.target.health <= 0) {
                                    gameState.units = gameState.units.filter(u => u !== enemy.target);
                                    enemy.target = null;
                                    enemy.state = 'moving';
                                }
                            }
                            enemy.lastAttackTime = now;
                        }
                    } else {
                        // –¶–µ–ª—å –≤—ã—à–ª–∞ –∏–∑ —Ä–∞–¥–∏—É—Å–∞ –∞—Ç–∞–∫–∏ - –ø—Ä–µ—Å–ª–µ–¥—É–µ–º
                        enemy.state = 'moving';
                    }
                }
            });
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö —é–Ω–∏—Ç–æ–≤
            gameState.units = gameState.units.filter(unit => unit.health > 0);
            gameState.enemyUnits = gameState.enemyUnits.filter(unit => unit.health > 0);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Ä–æ–Ω–µ
            gameState.damagePopups = gameState.damagePopups.filter(popup => {
                return now - popup.createdAt < popup.life;
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        function updateGame() {
            const currentTime = Date.now();
            
            // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –∑–æ–ª–æ—Ç–∞
            if (currentTime - gameState.lastGoldUpdate > 1000) {
                gameState.gold += gameState.mineProduction;
                gameState.lastGoldUpdate = currentTime;
                updateStats();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            if (currentTime - gameState.lastSecondUpdate > 1000) {
                if (gameState.currentScreen === 'game') {
                    if (gameState.gamePhase === 'preparation') {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
                        gameState.preparationTimeLeft -= 1;
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∞–ª–æ –±–∏—Ç–≤—ã –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
                        if (gameState.preparationTimeLeft <= 0) {
                            startBattle();
                        }
                    } else if (gameState.gamePhase === 'battle' && !gameState.gameOver) {
                        // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è –±–∏—Ç–≤—ã
                        gameState.battleTimeLeft -= 1;
                        
                        // –°–ø–∞–≤–Ω –≤—Ä–∞–∂–µ—Å–∫–∏—Ö —é–Ω–∏—Ç–æ–≤
                        gameState.enemySpawnTimer += 1;
                        if (gameState.enemySpawnTimer >= 2) { // –°–ø–∞–≤–Ω –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                            spawnEnemyUnit();
                            gameState.enemySpawnTimer = 0;
                        }
                    }
                }
                
                gameState.lastSecondUpdate = currentTime;
                updateStats();
            }
            
            // –ï—Å–ª–∏ –º—ã –≤ –∏–≥—Ä–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            if (gameState.currentScreen === 'game' && !gameState.gameOver) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∏ –∞—Ç–∞–∫ —é–Ω–∏—Ç–æ–≤
                updateUnits();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã
                if (gameState.playerHealth <= 0) {
                    gameState.gameOver = true;
                    gameState.gamesPlayed++;
                    
                    gameState.gameResult = 'lose';
                    resultTitle.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
                    resultMessage.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!';
                    
                    gameResult.classList.remove('hidden');
                    updateStats();
                } else if (gameState.gamePhase === 'battle' && gameState.battleTimeLeft <= 0) {
                    gameState.gameOver = true;
                    gameState.gamesPlayed++;
                    gameState.gamesWon++;
                    
                    gameState.gameResult = 'win';
                    resultTitle.textContent = '–ü–û–ë–ï–î–ê!';
                    resultMessage.textContent = '+1 –∫–ª—é—á, +50 –∑–æ–ª–æ—Ç–∞';
                    
                    // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–æ–±–µ–¥—É
                    gameState.keys += 1;
                    gameState.gold += 50;
                    
                    gameResult.classList.remove('hidden');
                    updateStats();
                }
            }
        }

        // –£–ª—É—á—à–µ–Ω–∏—è
        function upgradeMine() {
            if (gameState.gold >= gameState.mineUpgradeCost && gameState.mineLevel < 10) {
                gameState.gold -= gameState.mineUpgradeCost;
                gameState.mineLevel += 1;
                gameState.mineProduction += 1;
                gameState.mineUpgradeCost = Math.floor(gameState.mineUpgradeCost * 1.5);
                updateStats();
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                showNotification(`–®–∞—Ö—Ç–∞ —É–ª—É—á—à–µ–Ω–∞ –¥–æ —É—Ä–æ–≤–Ω—è ${gameState.mineLevel}!`);
            }
        }

        function produceKeys(amount) {
            const cost = amount * 1000;
            if (gameState.gold >= cost) {
                gameState.gold -= cost;
                gameState.keys += amount;
                updateStats();
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                showNotification(`–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ ${amount} –∫–ª—é—á–µ–π!`);
            }
        }

        function upgradeEnergy() {
            if (gameState.gold >= gameState.energyGenUpgradeCost && gameState.energyGenLevel < 10) {
                gameState.gold -= gameState.energyGenUpgradeCost;
                gameState.energyGenLevel += 1;
                gameState.maxEnergy += 20;
                gameState.energyGenUpgradeCost = Math.floor(gameState.energyGenUpgradeCost * 1.5);
                updateStats();
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                showNotification(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–æ ${gameState.maxEnergy}!`);
            }
        }

        function upgradeCastle() {
            if (gameState.gold >= gameState.castleUpgradeCost && gameState.castleLevel < 10) {
                gameState.gold -= gameState.castleUpgradeCost;
                gameState.castleLevel += 1;
                gameState.maxCastleHealth += 100;
                gameState.castleUpgradeCost = Math.floor(gameState.castleUpgradeCost * 1.5);
                updateStats();
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                showNotification(`–ó–∞–º–æ–∫ —É–∫—Ä–µ–ø–ª–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${gameState.castleLevel}!`);
            }
        }

        function openCase() {
            if (gameState.keys > 0) {
                gameState.keys -= 1;
                updateStats();
                
                // –ù–æ–≤—ã–µ —à–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è: 75% –∑–æ–ª–æ—Ç–æ, 25% –ø–µ—Ä—Å–æ–Ω–∞–∂
                const rarityRoll = Math.random();
                let targetRarity;
                
                if (rarityRoll < 0.75) {
                    // 75% —à–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è –∑–æ–ª–æ—Ç–∞
                    const goldReward = Math.floor(Math.random() * 401) + 100;
                    gameState.gold += goldReward;
                    showCaseResult(`üí∞ –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${goldReward} –∑–æ–ª–æ—Ç–∞!`);
                    updateStats();
                    return;
                }
                
                // 25% —à–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                const characterRoll = Math.random();
                if (characterRoll < 0.6) { // 60% –æ–±—ã—á–Ω—ã–π (–æ—Ç 25%)
                    targetRarity = 'common';
                } else if (characterRoll < 0.85) { // 25% —Ä–µ–¥–∫–∏–π (–æ—Ç 25%)
                    targetRarity = 'rare';
                } else if (characterRoll < 0.95) { // 10% —ç–ø–∏—á–µ—Å–∫–∏–π (–æ—Ç 25%)
                    targetRarity = 'epic';
                } else if (characterRoll < 0.99) { // 4% –º–∏—Ñ–∏—á–µ—Å–∫–∏–π (–æ—Ç 25%)
                    targetRarity = 'mythic';
                } else { // 1% –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π (–æ—Ç 25%)
                    targetRarity = 'legendary';
                }
                
                // –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —ç—Ç–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
                const availableChars = Object.keys(characters).filter(charId => 
                    !gameState.ownedCharacters.includes(charId) && characters[charId].rarity === targetRarity
                );
                
                let resultMessage;
                if (availableChars.length > 0) {
                    // –í—ã–ø–∞–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                    const randomCharId = availableChars[Math.floor(Math.random() * availableChars.length)];
                    gameState.ownedCharacters.push(randomCharId);
                    characters[randomCharId].owned = true;
                    resultMessage = `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${characters[randomCharId].name} (${targetRarity.toUpperCase()})!`;
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                    createCharacterButtons();
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                    if (gameState.currentScreen === 'cases') {
                        setTimeout(() => {
                            renderCharactersScreen();
                        }, 100);
                    }
                } else {
                    // –ï—Å–ª–∏ –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —ç—Ç–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ —É–∂–µ –µ—Å—Ç—å, –≤—ã–ø–∞–¥–∞–µ—Ç –∑–æ–ª–æ—Ç–æ
                    const goldReward = Math.floor(Math.random() * 401) + 100;
                    gameState.gold += goldReward;
                    resultMessage = `üí∞ –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${goldReward} –∑–æ–ª–æ—Ç–∞!`;
                }
                
                showCaseResult(resultMessage);
                updateStats();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showCaseResult(message) {
            caseResultMessage.textContent = message;
            caseResult.classList.remove('hidden');
        }

        function hideCaseResult() {
            caseResult.classList.add('hidden');
        }

        // –†–µ–Ω–¥–µ—Ä –∏–≥—Ä—ã
        function renderGame() {
            // –û—á–∏—Å—Ç–∫–∞ canvas
            ctx.fillStyle = COLORS.BACKGROUND;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // –ü–æ–ª–µ –±–æ—è - —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—ã–π –ª–∞–Ω–¥—à–∞—Ñ—Ç
            ctx.fillStyle = '#7cb342';
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // –¢–µ–∫—Å—Ç—É—Ä–∞ —Ç—Ä–∞–≤—ã
            ctx.fillStyle = '#689f38';
            for (let i = 0; i < SCREEN_WIDTH; i += 20) {
                for (let j = 0; j < SCREEN_HEIGHT; j += 20) {
                    if ((i + j) % 40 === 0) {
                        ctx.fillRect(i, j, 10, 10);
                    }
                }
            }
            
            // –ö—Ä–µ–ø–æ—Å—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
            const castleX = SCREEN_WIDTH / 2;
            const castleY = SCREEN_HEIGHT / 2;
            
            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–º–∫–∞
            ctx.fillStyle = '#6d4c41';
            ctx.beginPath();
            ctx.arc(castleX, castleY, 80, 0, Math.PI * 2);
            ctx.fill();
            
            // –î–µ—Ç–∞–ª–∏ –∑–∞–º–∫–∞
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(castleX - 40, castleY - 60, 80, 40); // –ë–∞—à–Ω—è
            ctx.fillRect(castleX - 60, castleY - 20, 120, 20); // –°—Ç–µ–Ω–∞
            
            // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∑–∞–º–∫–∞
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(castleX - 50, castleY - 80, 100, 10);
            ctx.fillStyle = COLORS.HEALTH;
            ctx.fillRect(castleX - 50, castleY - 80, 100 * (gameState.playerHealth / gameState.maxCastleHealth), 10);
            
            // –Æ–Ω–∏—Ç—ã –∏–≥—Ä–æ–∫–∞
            gameState.units.forEach(unit => {
                const character = characters[unit.characterId];
                
                // –Æ–Ω–∏—Ç
                if (images[unit.image]) {
                    ctx.drawImage(images[unit.image], unit.x - 30, unit.y - 30, 60, 60);
                } else {
                    // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    ctx.fillStyle = '#8d6e63';
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, 30, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#5d4037';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–Æ–ù–ò–¢', unit.x, unit.y + 5);
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —é–Ω–∏—Ç–∞
                ctx.fillStyle = '#5d4037';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60, 8);
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60 * (unit.health / unit.maxHealth), 8);
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (unit.isExecuting) {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#4fc3f7';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚ö°', unit.x, unit.y - 50);
                }
                
                // –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —é–Ω–∏—Ç–∞
                if (gameState.selectedUnit === unit) {
                    ctx.strokeStyle = '#4fc3f7';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, 35, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // –†–∞–¥–∏—É—Å –∞—Ç–∞–∫–∏
                    ctx.strokeStyle = 'rgba(239, 83, 80, 0.3)';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, character.attack_range, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // –†–∞–¥–∏—É—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏
                    ctx.strokeStyle = 'rgba(79, 195, 247, 0.3)';
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, character.vision_range, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.setLineDash([]);
                    
                    // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
                    ctx.fillStyle = 'rgba(93, 64, 55, 0.9)';
                    ctx.fillRect(unit.x - 40, unit.y - 80, 80, 25);
                    ctx.strokeStyle = '#8d6e63';
                    ctx.strokeRect(unit.x - 40, unit.y - 80, 80, 25);
                    ctx.fillStyle = '#f5e8c8';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å', unit.x, unit.y - 65);
                }
            });
            
            // –í—Ä–∞–∂–µ—Å–∫–∏–µ —é–Ω–∏—Ç—ã
            gameState.enemyUnits.forEach(unit => {
                // –Æ–Ω–∏—Ç
                if (images[unit.image]) {
                    ctx.drawImage(images[unit.image], unit.x - 30, unit.y - 30, 60, 60);
                } else {
                    // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    ctx.fillStyle = '#5d4037';
                    ctx.beginPath();
                    ctx.arc(unit.x, unit.y, 30, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#ef5350';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–í–†–ê–ì', unit.x, unit.y + 5);
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —é–Ω–∏—Ç–∞
                ctx.fillStyle = '#5d4037';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60, 8);
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(unit.x - 30, unit.y - 40, 60 * (unit.health / unit.maxHealth), 8);
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (unit.state === 'attacking') {
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#ef5350';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚öîÔ∏è', unit.x, unit.y - 50);
                }
            });
            
            // –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Ä–æ–Ω–µ
            const now = Date.now();
            gameState.damagePopups.forEach(popup => {
                const progress = (now - popup.createdAt) / popup.life;
                const y = popup.y - progress * 50;
                const alpha = 1 - progress;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.font = 'bold 18px Arial';
                ctx.fillStyle = popup.color;
                ctx.textAlign = 'center';
                ctx.fillText(popup.text, popup.x, y);
                ctx.restore();
            });
            
            // –û–±–ª–∞—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ —Ñ–∞–∑–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏)
            if (gameState.gamePhase === 'preparation') {
                ctx.strokeStyle = 'rgba(79, 195, 247, 0.5)';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(castleX, castleY, 120, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                ctx.fillStyle = 'rgba(93, 64, 55, 0.8)';
                ctx.fillRect(castleX - 150, castleY + 100, 300, 40);
                ctx.fillStyle = '#f5e8c8';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —é–Ω–∏—Ç–æ–≤ –≤–æ–∫—Ä—É–≥ –∫—Ä–µ–ø–æ—Å—Ç–∏', castleX, castleY + 125);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ canvas
        function handleCanvasClick(x, y) {
            if (gameState.currentScreen !== 'game' || gameState.gameOver) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
            if (gameState.selectedUnit) {
                const unit = gameState.selectedUnit;
                if (x >= unit.x - 40 && x <= unit.x + 40 && 
                    y >= unit.y - 80 && y <= unit.y - 55) {
                    openProgrammingPanel();
                    return;
                }
            }
            
            // –í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—â–∞—Ç—å —é–Ω–∏—Ç–æ–≤, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ñ–∞–∑—ã –∏–≥—Ä—ã
            if (gameState.selectedCharacter) {
                placeUnit(x, y);
            } else {
                // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–±—Ä–∞—Ç—å —é–Ω–∏—Ç–∞
                if (!selectUnit(x, y)) {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ
                    gameState.selectedCharacter = null;
                    gameState.selectedUnit = null;
                }
            }
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updateGame();
            
            if (gameState.currentScreen === 'game') {
                renderGame();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ canvas
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            handleCanvasClick(x, y);
        });

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        init();
    </script>
</body>
</html>
